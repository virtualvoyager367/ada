<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ADA AI Chat</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: #181818;
      color: #fff;
      font-family: 'Segoe UI', Arial, sans-serif;
      overflow: hidden; /* Prevent scrolling on AI page */
    }
    *, *::before, *::after {
      font-family: inherit;
    }
    .light-mode body, .light-mode html {
      background: #f5f5f5 !important;
    }
    .ada-chat-container {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      min-height: 100vh;
      background: #181818;
      width: calc(100vw - 240px);
      height: 100vh;
      box-sizing: border-box;
      overflow: hidden;
      margin-top: 0;
      margin-bottom: 0;
      margin-left: 240px;
      justify-content: flex-end;
      padding-bottom: 0; /* Remove padding since chat window is positioned independently */
      padding-top: 0;   /* Remove padding since chat window is positioned independently */
      z-index: 1;
      /* Remove margin-top to keep content lower */
      height: 100vh;
      overflow: hidden;
      transition: width 0.2s cubic-bezier(.4,0,.2,1), margin-left 0.2s cubic-bezier(.4,0,.2,1);
    }
    .light-mode .ada-chat-container {
      background: #f5f5f5;
    }
    .circle-container {
      margin-top: 32px; margin-bottom: 8px; display: flex; justify-content: center; align-items: center; height: 180px;
    }
    .pulse-outer {
      width: 160px; height: 160px; border-radius: 50%; background: #1ed760; display: flex; align-items: center; justify-content: center; position: relative; box-shadow: 0 0 48px 0 #1ed76099; animation: pulse-bright 5s infinite cubic-bezier(.4,0,.2,1);
      transition: background 0.4s cubic-bezier(.4,0,.2,1), box-shadow 0.4s cubic-bezier(.4,0,.2,1);
    }
    .pulse-outer.no-pulse {
      animation: none;
    }
    .pulse-outer.thinking {
      background: #2196f3; box-shadow: 0 0 48px 0 #2196f399; animation: none;
    }
    .pulse-outer.offline {
      background: #666;
      box-shadow: 0 0 48px 0 #666999;
      animation: none;
    }
    .pulse-outer.error {
      background: #e53935 !important;
      box-shadow: 0 0 48px 0 #e5393599 !important;
      animation: none !important;
    }
    .pulse-inner-anim {
      position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); border-radius: 50%; background: #19b84c; z-index: 1; transition: background 0.3s;
      box-shadow: 0 0 18px 0 #19b84c55;
      animation: pulse-bright-inner 5s infinite cubic-bezier(.4,0,.2,1);
    }
    .pulse-outer.no-pulse .pulse-inner-anim {
      animation: none;
    }
    .pulse-outer.thinking .pulse-inner-anim {
      background: #1761a0;
      box-shadow: 0 0 18px 0 #1761a055;
      animation: pulse-bright-inner-blue 5s infinite cubic-bezier(.4,0,.2,1);
    }
    .pulse-outer.offline .pulse-inner-anim {
      background: #444;
      box-shadow: 0 0 18px 0 #444555;
      animation: none;
    }
    .pulse-inner-anim.error {
      background: #a31515 !important;
      box-shadow: 0 0 18px 0 #a3151555 !important;
      animation: none !important;
    }
    .pulse-inner {
      width: 32px; height: 32px; border-radius: 50%; background: #fff; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); z-index: 2; box-shadow: 0 0 0 0 #fff0;
    }
    @keyframes pulse-bright {
      0%, 60% {
        background: #1ed760;
        box-shadow: 0 0 48px 0 #1ed76099;
      }
      70% {
        background: #aaffc6;
        box-shadow: 0 0 48px 0 #aaffc699;
      }
      90%, 100% {
        background: #1ed760;
        box-shadow: 0 0 48px 0 #1ed76099;
      }
    }
    @keyframes pulse-bright-inner {
      0%, 60% {
        background: #19b84c;
        box-shadow: 0 0 18px 0 #19b84c55;
      }
      70% {
        background: #b6ffc6;
        box-shadow: 0 0 18px 0 #b6ffc655;
      }
      90%, 100% {
        background: #19b84c;
        box-shadow: 0 0 18px 0 #19b84c55;
      }
    }
    @keyframes pulse-bright-inner-blue {
      0%, 60% {
        background: #1761a0;
        box-shadow: 0 0 18px 0 #1761a055;
      }
      70% {
        background: #7ecbff;
        box-shadow: 0 0 18px 0 #7ecbff55;
      }
      90%, 100% {
        background: #1761a0;
        box-shadow: 0 0 18px 0 #1761a055;
      }
    }
    .ada-waiting {
      min-height: 28px;
      text-align: center;
      font-size: 1.3rem;
      color: #b6ffc6;
      letter-spacing: 0.2em;
      margin-bottom: 16px;
      font-family: 'Fira Mono', 'Consolas', monospace;
      user-select: none;
      transition: color 0.3s;
    }
    .pulse-outer.thinking ~ .ada-waiting {
      color: #7ecbff;
    }
    .ai-status {
      min-height: 28px;
      text-align: center;
      font-size: 1.1rem;
      color: #b6ffc6;
      margin-bottom: 16px;
      font-weight: 500;
      user-select: none;
      transition: color 0.3s;
      display: block;
    }
    .ai-status.thinking-status {
      color: #1761a0;
    }
    .light-mode .ai-status.thinking-status {
      color: #1761a0;
    }
    .light-mode .ai-status {
      color: #19b84c;
    }
    .pulse-outer.thinking ~ .ai-status {
      color: #7ecbff;
    }
    .light-mode .pulse-outer.thinking ~ .ai-status {
      color: #2196f3;
    }
    .ai-status.error-status {
      color: #e53935 !important;
      font-weight: bold;
      text-shadow: 0 2px 8px #e5393533;
      letter-spacing: 0.04em;
      animation: shake 0.4s;
    }
    .chat-window {
      width: calc(100vw - 240px); /* Full width minus sidebar */
      max-width: none;
      background: rgba(34, 35, 42, 0.5); /* 50% transparent background */
      border-radius: 0; /* Remove rounded corners to connect to edges */
      box-shadow: none; /* Remove popup shadow */
      display: flex;
      flex-direction: column;
      height: calc(100vh - 54px); /* Go from bottom of topbar (54px) to bottom of screen */
      min-height: 320px;
      max-height: 100vh;
      overflow: hidden;
      margin-bottom: 0;
      margin: 0;
      animation: fadein 0.7s cubic-bezier(.4,0,.2,1);
      z-index: 1;
      position: fixed; /* Position fixed to connect to edges */
      top: 54px; /* Start from bottom of topbar */
      left: 240px; /* Start from right edge of sidebar */
      bottom: 0; /* Extend to bottom edge */
    }
    .light-mode .chat-window {
      background: rgba(255, 255, 255, 0.5); /* 50% transparent white background */
      box-shadow: none; /* Remove popup shadow */
    }
    @keyframes fadein { from { opacity: 0; transform: translateY(40px);} to { opacity: 1; transform: none; } }
    .chat-topbar {
      display: flex; align-items: center; justify-content: space-between; background: #23242b; padding: 0 16px; height: 44px; border-bottom: 1px solid #23242b;
    }
    .light-mode .chat-topbar {
      background: #f8f9fa; border-bottom: 1px solid #e9ecef;
    }
    .chat-title {
      font-size: 1.1rem; font-weight: 600; color: #fff; letter-spacing: 0.01em;
    }
    .light-mode .chat-title {
      color: #333;
    }
    .topbar-buttons {
      display: flex; gap: 8px; align-items: center;
    }
    .mode-dropdown {
      background: #2a2b32; border: 1px solid #444; border-radius: 6px; padding: 6px 12px; color: #fff; font-size: 0.9rem; cursor: pointer; outline: none; transition: border-color 0.2s;
    }
    .light-mode .mode-dropdown {
      background: #fff; border-color: #ddd; color: #333;
    }
    .mode-dropdown:focus {
      border-color: #1ed760;
    }
    .settings-btn {
      background: none; border: none; cursor: pointer; padding: 0; margin: 0; outline: none; display: flex; align-items: center;
      transition: transform 0.1s;
    }
    .settings-btn:active { transform: scale(0.92); }
    .settings-icon {
      width: 22px; height: 22px; display: block;
      fill: #aaa; transition: fill 0.2s;
    }
    .settings-btn:hover .settings-icon { fill: #1ed760; }
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px 16px 8px 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      background: #22232a;
      min-height: 0;
      max-height: 100%;
    }
    .light-mode .messages {
      background: #fff;
    }
    .message {
      max-width: 70%; padding: 12px 18px; border-radius: 16px; font-size: 1.08rem; line-height: 1.5; word-break: break-word; box-shadow: 0 1px 4px 0 #0002; opacity: 0; transform: translateY(20px); animation: msgin 0.4s cubic-bezier(.4,0,.2,1) forwards;
    }
    .message.user {
      align-self: flex-end; background: linear-gradient(90deg, #1ed760 60%, #1ed760cc 100%); color: #181818; animation-delay: 0.05s;
    }
    .message.ada {
      align-self: flex-start; background: #2a2b32; color: #fff; animation-delay: 0.1s; max-width: 75%; margin-right: 25%;
    }
    .light-mode .message.ada {
      background: #e9ecef; color: #333;
    }
    @keyframes msgin { to { opacity: 1; transform: none; } }
    .chat-input-row {
      display: flex; padding: 12px 24px; background: #23242b; border-top: 1px solid #23242b; gap: 8px;
    }
    .light-mode .chat-input-row {
      background: #f8f9fa; border-top: 1px solid #e9ecef;
    }
    .chat-input {
      flex: 1; padding: 10px 14px; border-radius: 8px; border: none; font-size: 1rem; background: #181818; color: #fff; outline: none; transition: box-shadow 0.2s; font-family: inherit; line-height: 1.4; min-height: 20px; max-height: 100px; overflow-y: auto;
    }
    .light-mode .chat-input {
      background: #fff; color: #333; border: 1px solid #ddd;
    }
    .chat-input:focus {
      box-shadow: 0 0 0 2px #1ed76088;
    }
    .send-btn {
      background: #1ed760; color: #181818; border: none; border-radius: 8px; padding: 0 24px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background 0.2s, transform 0.1s; min-width: 80px;
    }
    .send-btn:active { transform: scale(0.96); }
    .send-btn:disabled {
      background: #444; color: #aaa; cursor: not-allowed;
    }
    .light-mode .send-btn:disabled {
      background: #ccc; color: #666; cursor: not-allowed;
    }
    .conversation-id {
      font-size: 0.8rem; color: #aaa; margin: 8px 16px; user-select: all; text-align: left;
      padding: 4px 0;
      border-bottom: 1px solid #333;
    }
    .light-mode .conversation-id {
      color: #666;
    }
    /* Settings Modal */
    .settings-modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 20000;
    }
    .settings-modal.show {
      display: flex;
    }
    .settings-content {
      background: #22232a; border-radius: 16px; padding: 24px; width: 90%; max-width: 400px; box-shadow: 0 4px 32px 0 #000a;
    }
    .light-mode .settings-content {
      background: #fff; box-shadow: 0 4px 32px 0 #0002;
    }
    .settings-header {
      display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px;
    }
    .settings-title {
      font-size: 1.2rem; font-weight: 600; color: #fff;
    }
    .light-mode .settings-title {
      color: #333;
    }
    .close-btn {
      background: none; border: none; cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s;
    }
    .close-btn:hover {
      background: #333;
    }
    .light-mode .close-btn:hover {
      background: #f0f0f0;
    }
    .theme-buttons {
      display: flex; gap: 16px; margin-bottom: 20px;
    }
    .theme-btn {
      flex: 1; padding: 16px; border: 2px solid transparent; border-radius: 12px; cursor: pointer; transition: all 0.3s; background: #2a2b32; position: relative; overflow: hidden;
    }
    .theme-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px 0 #0004;
    }
    .theme-btn.active {
      border-color: #1ed760;
      box-shadow: 0 0 0 2px #1ed76033;
    }
    .theme-btn.dark {
      background: #181818;
    }
    .theme-btn.light {
      background: #f5f5f5;
    }
    .theme-preview {
      height: 80px; border-radius: 8px; margin-bottom: 12px; position: relative; overflow: hidden;
    }
    .theme-btn.dark .theme-preview {
      background: #22232a;
    }
    .theme-btn.light .theme-preview {
      background: #fff;
    }
    .preview-bubble {
      position: absolute; width: 60px; height: 24px; border-radius: 12px; bottom: 8px;
    }
    .theme-btn.dark .preview-bubble.user {
      background: #1ed760; right: 8px;
    }
    .theme-btn.dark .preview-bubble.ada {
      background: #2a2b32; left: 8px;
    }
    .theme-btn.light .preview-bubble.user {
      background: #1ed760; right: 8px;
    }
    .theme-btn.light .preview-bubble.ada {
      background: #e9ecef; left: 8px;
    }
    .theme-label {
      font-size: 0.9rem; font-weight: 600; color: #fff; text-align: center;
    }
    .theme-btn.light .theme-label {
      color: #333;
    }
    .pulse-toggle {
      display: flex; align-items: center; justify-content: space-between; padding: 12px 0;
    }
    .pulse-toggle .theme-label {
      font-size: 1rem; color: #fff;
    }
    .light-mode .pulse-toggle .theme-label {
      color: #333;
    }
    .toggle-switch {
      position: relative; width: 48px; height: 24px; background: #444; border-radius: 12px; cursor: pointer; transition: background 0.3s;
    }
    .toggle-switch.active {
      background: #1ed760;
    }
    .toggle-switch::after {
      content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: #fff; border-radius: 50%; transition: transform 0.3s cubic-bezier(.4,0,.2,1), background 0.2s;
    }
    .toggle-switch.active::after {
      transform: translateX(24px);
    }
    .audio-section {
      margin-top: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .audio-btn {
      background: #1ed760;
      color: #181818;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
    }
    .audio-btn:active {
      transform: scale(0.96);
    }
    .audio-btn:disabled {
      background: #444;
      color: #aaa;
      cursor: not-allowed;
    }
    .light-mode .audio-btn:disabled {
      background: #ccc;
      color: #666;
      cursor: not-allowed;
    }
    /* Modern login styles */
    #loginContainer {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 10000;
      min-height: 100vh;
      min-width: 100vw;
      overflow: hidden;
      background: #181818;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.5s;
      /* Add stacking context for login background */
      pointer-events: auto;
    }
    .light-mode #loginContainer {
      background: #f5f5f5;
    }
    /* Remove old .login-bg-shape styles and add canvas-based particle network */
    .login-bg-anim {
      position: absolute;
      top: 0; left: 0; width: 100vw; height: 100vh;
      z-index: 0;
      overflow: hidden;
      pointer-events: none;
    }
    /* Remove .login-bg-shape1,2,3 and their keyframes */
    .login-box {
      position: relative;
      z-index: 1;
      background: rgba(34, 34, 40, 0.92);
      border-radius: 18px;
      box-shadow: 0 8px 32px 0 rgba(0,0,0,0.25);
      padding: 20px;
      max-width: 300px;
      width: 100%;
      min-height: 260px;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background 0.5s;
      animation: login-box-in 0.7s cubic-bezier(.68,-0.55,.27,1.55);
    }
    .light-mode .login-box {
      background: rgba(255,255,255,0.92);
      box-shadow: 0 8px 32px 0 rgba(0,0,0,0.10);
    }
    @keyframes login-box-in {
      0% { opacity: 0; transform: translateY(40px) scale(0.95); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }
    .login-box h2 {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 8px;
      margin-top: 0;
      color: #fff;
      letter-spacing: 1px;
      text-shadow: 0 2px 8px #0002;
      transition: color 0.5s;
      text-align: center;
    }
    .light-mode .login-box h2 {
      color: #222;
      text-shadow: none;
    }
    .login-form-flex {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      height: 180px;
      width: 100%;
      max-width: 260px;
      margin: 0 auto;
      align-items: stretch;
    }
    #loginForm input,
    #loginForm button {
      width: 100%;
      box-sizing: border-box;
    }
    #loginForm input {
      width: 100%;
      max-width: none;
      align-self: stretch;
      padding: 12px 14px;
      margin: 0;
      border: 1px solid #444;
      border-radius: 8px;
      font-size: 1.1rem;
      background: #23242a;
      color: #fff;
      box-shadow: 0 2px 8px #0001;
      outline: none;
      transition: background 0.3s, color 0.3s, box-shadow 0.2s, border 0.2s;
      animation: login-input-in 0.7s cubic-bezier(.68,-0.55,.27,1.55);
    }
    .light-mode #loginForm input {
      background: #f5f5f5;
      color: #222;
      border: 1px solid #bbb;
    }
    #loginForm input + input {
      margin-top: 18px;
    }
    #loginForm button {
      width: 100%;
      padding: 12px 0;
      margin-top: 18px;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      background: linear-gradient(90deg, #1ed760 60%, #1761a0 100%);
      color: #181818;
      cursor: pointer;
      box-shadow: 0 2px 8px #0002;
      transition: background 0.2s, transform 0.1s;
      animation: login-btn-in 0.7s cubic-bezier(.68,-0.55,.27,1.55);
    }
    #loginForm button.login-btn-loading {
      background: #888 !important;
      color: #eee !important;
      transform: scale(0.96);
      cursor: not-allowed;
      filter: grayscale(0.2);
    }
    #loginForm button:active {
      transform: scale(0.97);
    }
    .light-mode #loginForm button {
      background: linear-gradient(90deg, #aaffc6 60%, #1761a0 100%);
      color: #222;
    }
    @keyframes login-btn-in {
      0% { opacity: 0; transform: translateY(20px) scale(0.98); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }
    #loginError {
      color: #ff4d4f;
      font-size: 1rem;
      margin-top: 10px;
      display: none;
      animation: shake 0.3s;
    }
    @keyframes shake {
      0% { transform: translateX(0); }
      20% { transform: translateX(-8px); }
      40% { transform: translateX(8px); }
      60% { transform: translateX(-6px); }
      80% { transform: translateX(6px); }
      100% { transform: translateX(0); }
    }
    /* Particle network background for both login and main app */
    #particleBgCanvas {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      z-index: 0;
      pointer-events: none;
      display: block;
    }
    #loginBgCanvas {
      position: absolute;
      top: 0; left: 0; width: 100vw; height: 100vh;
      z-index: 0;
      pointer-events: none;
      display: block;
    }
    .ada-chat-container {
      z-index: 1;
      /* Remove margin-top to keep content lower */
      height: 100vh;
      overflow: hidden;
    }
    .messages {
      padding-top: 8px;
    }
    .login-box {
      z-index: 1;
    }
    .chat-topbar, .settings-btn, .conversation-id, .ai-status {
      position: relative;
      z-index: 3;
    }
    .login-bg-anim, .main-bg-anim { display: none; }
    /* Markdown styles for chat bubbles */
    .message .markdown {
      font-family: inherit;
      font-size: 1rem;
      line-height: 1.6;
    }
    .message .markdown pre {
      background: #23242a;
      color: #aaffc6;
      border-radius: 6px;
      padding: 10px;
      overflow-x: auto;
      font-size: 0.98em;
      margin: 8px 0;
    }
    .light-mode .message .markdown pre {
      background: #f5f5f5;
      color: #1761a0;
    }
    .message .markdown code {
      background: #23242a;
      color: #aaffc6;
      border-radius: 4px;
      padding: 2px 6px;
      font-size: 0.98em;
    }
    .light-mode .message .markdown code {
      background: #f5f5f5;
      color: #1761a0;
    }
    .message .markdown a {
      color: #1ed760;
      text-decoration: underline;
      word-break: break-all;
    }
    .light-mode .message .markdown a {
      color: #1761a0;
    }
    .message .markdown ul, .message .markdown ol {
      margin: 8px 0 8px 24px;
    }
    .message .markdown blockquote {
      border-left: 3px solid #1ed760;
      margin: 8px 0;
      padding-left: 12px;
      color: #888;
      font-style: italic;
    }
    .light-mode .message .markdown blockquote {
      border-left: 3px solid #1761a0;
      color: #666;
    }
    .message .markdown strong,
    .message .markdown em,
    .message .markdown code,
    .message .markdown a {
      display: inline;
      margin: 0;
      padding: 0;
      line-height: inherit;
      vertical-align: baseline;
    }
    .message .markdown h1,
    .message .markdown h2,
    .message .markdown h3,
    .message .markdown h4,
    .message .markdown h5,
    .message .markdown h6,
    .message .markdown ul,
    .message .markdown ol,
    .message .markdown pre,
    .message .markdown blockquote {
      margin-top: 12px;
      margin-bottom: 12px;
      display: block;
    }
    .message .markdown p {
      margin: 0;
      display: block;
    }
    /* Top bar for AI page */
    .ai-topbar {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 54px;
      background: rgba(34, 34, 40, 0.97);
      color: #fff;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      box-shadow: 0 2px 12px 0 rgba(0,0,0,0.08);
      padding: 0 32px;
      font-size: 1.1rem;
    }
    .light-mode .ai-topbar {
      background: rgba(255,255,255,0.97);
      color: #222;
    }
    .profile-menu {
      position: relative;
      margin-left: auto;
      display: flex;
      align-items: center;
      user-select: none;
      gap: 0;
    }
    .profile-userbox {
      display: flex;
      align-items: center;
      gap: 0;
      cursor: pointer;
    }
    .profile-avatar, #profileName {
      cursor: pointer;
    }
    .profile-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, #1ed760 60%, #1761a0 100%);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.2rem;
      margin-right: 12px;
      box-shadow: 0 2px 8px #0002;
    }
    .profile-displayname {
      font-size: 1.1rem;
      font-weight: 600;
      color: #fff;
      margin-right: 16px;
      user-select: text;
      transition: color 0.3s;
    }
    .light-mode .profile-displayname {
      color: #222;
    }
    /* Profile Modal Styles */
    .profile-modal-overlay {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.5);
      z-index: 99999;
      display: none;
      align-items: center;
      justify-content: center;
      transition: background 0.3s;
    }
    .profile-modal-overlay.show {
      display: flex;
    }
    .profile-modal {
      background: #23242a;
      color: #fff;
      border-radius: 18px;
      box-shadow: 0 8px 32px 0 rgba(0,0,0,0.25);
      padding: 36px 40px 32px 40px;
      min-width: 340px;
      max-width: 96vw;
      width: 420px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 32px;
      position: fixed;
      z-index: 99999;
      animation: login-box-in 0.7s cubic-bezier(.68,-0.55,.27,1.55);
    }
    .light-mode .profile-modal {
      background: #fff;
      color: #222;
      box-shadow: 0 8px 32px 0 rgba(0,0,0,0.10);
    }
    .profile-modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0;
      color: #fff;
      text-align: center;
    }
    .light-mode .profile-modal-title {
      color: #222;
    }
    .profile-modal-btns {
      display: flex;
      flex-direction: row;
      gap: 32px;
      width: 100%;
      justify-content: center;
    }
    .profile-modal-btn {
      flex: 1 1 0;
      padding: 18px 0;
      font-size: 1.1rem;
      font-weight: 600;
      border: none;
      border-radius: 10px;
      background: linear-gradient(90deg, #1ed760 60%, #1761a0 100%);
      color: #181818;
      cursor: pointer;
      transition: background 0.2s, color 0.2s, box-shadow 0.2s, transform 0.12s cubic-bezier(.4,0,.2,1);
      box-shadow: 0 2px 8px #0002;
    }
    .profile-modal-btn:active {
      transform: scale(0.96);
      box-shadow: 0 2px 12px 0 #0003;
    }
    .light-mode .profile-modal-btn {
      background: linear-gradient(90deg, #aaffc6 60%, #1761a0 100%);
      color: #222;
    }
    .profile-modal-btn:hover, .send-btn:hover, .settings-btn:hover, .audio-btn:hover, .close-btn:hover {
      box-shadow: 0 4px 18px 0 #1ed76033;
      filter: brightness(1.04);
    }
    /* Logout button hover pulse */
    #profileModalLogoutBtn:hover {
      animation: pulse-logout 0.5s;
      box-shadow: 0 0 0 4px #ff525233;
      filter: brightness(1.08);
    }
    @keyframes pulse-logout {
      0% { box-shadow: 0 0 0 0 #ff525233; }
      60% { box-shadow: 0 0 0 8px #ff525233; }
      100% { box-shadow: 0 0 0 4px #ff525233; }
    }
    .profile-modal-close {
      position: absolute;
      top: 18px;
      right: 18px;
      background: none;
      border: none;
      font-size: 1.5rem;
      color: #aaa;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.2s, color 0.2s;
    }
    .profile-modal-close:hover {
      background: #333;
      color: #fff;
    }
    .light-mode .profile-modal-close:hover {
      background: #f0f0f0;
      color: #222;
    }
    .profile-label {
      font-size: 0.98em;
      color: #aaa;
      margin-bottom: 2px;
    }
    .light-mode .profile-label {
      color: #888;
    }
    .profile-value {
      font-weight: 600;
      margin-bottom: 8px;
      color: #fff;
    }
    .light-mode .profile-value {
      color: #222;
    }
    .profile-dropdown input[type="text"],
    .profile-dropdown input[type="password"] {
      width: 100%;
      max-width: 180px;
      margin-left: auto;
      margin-right: auto;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #444;
      background: #18191a;
      color: #fff;
      font-size: 1em;
      margin-bottom: 8px;
      outline: none;
      transition: border 0.2s;
    }
    .light-mode .profile-dropdown input[type="text"],
    .light-mode .profile-dropdown input[type="password"] {
      background: #f5f5f5;
      color: #222;
      border: 1px solid #bbb;
    }
    .profile-dropdown button {
      width: 100%;
      padding: 8px 0;
      border: none;
      border-radius: 6px;
      background: linear-gradient(90deg, #1ed760 60%, #1761a0 100%);
      color: #181818;
      font-weight: 600;
      font-size: 1em;
      cursor: pointer;
      margin-top: 2px;
      transition: background 0.2s;
    }
    .profile-dropdown .profile-success {
      color: #1ed760;
      font-size: 0.98em;
      margin-top: 4px;
    }
    .profile-dropdown .profile-error {
      color: #ff4d4f;
      font-size: 0.98em;
      margin-top: 4px;
    }
    @keyframes fadeInProfile {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    /* Profile Section Popups */
    .profile-section-modal {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.5);
      z-index: 99999;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .profile-section-modal.show {
      display: flex;
    }
    .profile-section-content {
      background: #23242a;
      color: #fff;
      border-radius: 18px;
      box-shadow: 0 8px 32px 0 rgba(0,0,0,0.25);
      padding: 36px 40px 32px 40px;
      min-width: 340px;
      max-width: 96vw;
      width: 420px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
      position: fixed;
      z-index: 99999;
      animation: login-box-in 0.7s cubic-bezier(.68,-0.55,.27,1.55);
    }
    .light-mode .profile-section-content {
      background: #fff;
      color: #222;
      box-shadow: 0 8px 32px 0 rgba(0,0,0,0.10);
    }
    /* Success and error messages */
    .profile-section-success {
      color: #1ed760 !important;
      font-size: 0.98em;
      margin-top: 4px;
      text-align: center;
    }
    .profile-section-error {
      color: #ff4d4f !important;
      font-size: 0.98em;
      margin-top: 4px;
      text-align: center;
    }
    /* Remove any other profile-section-success styles */
    .profile-section-content .profile-section-success {
      color: #1ed760 !important;
    }
    .profile-section-title {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 0;
      color: #fff;
      text-align: center;
    }
    .light-mode .profile-section-title {
      color: #222;
    }
    .profile-section-back {
      position: absolute;
      top: 18px;
      left: 18px;
      background: none;
      border: none;
      font-size: 1.3rem;
      color: #aaa;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.2s, color 0.2s;
    }
    .profile-section-back:hover {
      background: #333;
      color: #fff;
    }
    .light-mode .profile-section-back:hover {
      background: #f0f0f0;
      color: #222;
    }
    .profile-section-form {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 16px;
      align-items: stretch;
    }
    .profile-section-form label {
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 4px;
    }
    .profile-section-form input {
      padding: 12px 14px;
      border-radius: 8px;
      border: 1px solid #444;
      font-size: 1.1rem;
      background: #23242a;
      color: #fff;
      box-shadow: 0 2px 8px #0001;
      outline: none;
      transition: background 0.3s, color 0.3s, box-shadow 0.2s, border 0.2s;
    }
    .light-mode .profile-section-form input {
      background: #f5f5f5;
      color: #222;
      border: 1px solid #bbb;
    }
    .profile-section-form button {
      padding: 12px 0;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      background: linear-gradient(90deg, #1ed760 60%, #1761a0 100%);
      color: #181818;
      cursor: pointer;
      box-shadow: 0 2px 8px #0002;
      transition: background 0.2s, transform 0.1s;
    }
    .profile-section-form button:active {
      transform: scale(0.97);
    }
    .light-mode .profile-section-form button {
      background: linear-gradient(90deg, #aaffc6 60%, #1761a0 100%);
      color: #222;
    }
    /* Input focus glow */
    .chat-input:focus, .profile-section-form input:focus, #loginForm input:focus {
      box-shadow: 0 0 0 2px #1ed76088;
      border-color: #1ed760;
      transition: box-shadow 0.2s, border 0.2s;
    }
    /* Modal pop-in animation */
    .profile-modal, .settings-content, .profile-section-content {
      animation: modal-popin 0.5s cubic-bezier(.68,-0.55,.27,1.55);
    }
    @keyframes modal-popin {
      0% { opacity: 0; transform: scale(0.92) translateY(30px); }
      100% { opacity: 1; transform: scale(1) translateY(0); }
    }
    /* Profile avatar hover */
    .profile-avatar {
      transition: box-shadow 0.2s, transform 0.15s cubic-bezier(.4,0,.2,1);
    }
    .profile-avatar:hover {
      box-shadow: 0 4px 18px 0 #1ed76055;
      transform: scale(1.08);
      filter: brightness(1.08);
    }
    /* Theme toggle switch animation */
    .toggle-switch {
      transition: background 0.3s;
    }
    .toggle-switch::after {
      transition: transform 0.3s cubic-bezier(.4,0,.2,1), background 0.2s;
    }
    /* Enhance message entry animation */
    .message {
      opacity: 0;
      transform: translateY(20px) scale(0.98);
      animation: msgin 0.4s cubic-bezier(.4,0,.2,1) forwards;
    }
    @keyframes msgin {
      to { opacity: 1; transform: none; }
    }
    /* Button hover: enlarge and green glow (except logout) */
    .profile-modal-btn:not(#profileModalLogoutBtn):hover,
    .send-btn:hover,
    .settings-btn:hover,
    .audio-btn:hover,
    .close-btn:hover,
    #loginForm button:hover {
      box-shadow: 0 4px 18px 0 #1ed76055;
      transform: scale(1.08);
      filter: brightness(1.08);
    }
    .profile-section-form button:hover {
      box-shadow: 0 4px 18px 0 #1ed76055;
      transform: scale(1.08);
      filter: brightness(1.08);
    }
    .send-btn.login-btn-loading {
      background: #888 !important;
      color: #eee !important;
      transform: scale(0.96);
      cursor: not-allowed;
      filter: grayscale(0.2);
    }
    /* File preview row and box styles */
    #filePreviewArea {
      width: 100%;
      max-width: 480px;
      margin: 0 auto 8px auto;
      background: #292a31;
      border-radius: 18px;
      box-shadow: 0 2px 12px 0 #0003;
      padding: 12px 18px 12px 18px;
      display: flex;
      align-items: center;
      gap: 0;
      overflow-x: auto;
      min-height: 64px;
      position: relative;
      z-index: 3;
      border: 2.5px solid #23242a;
    }
    .light-mode #filePreviewArea {
      background: #f5f5f5;
      border: 2.5px solid #e9ecef;
      box-shadow: 0 2px 12px 0 #0001;
    }
    #filePreviewArea .file-preview-box {
      position: relative;
      background: #23242a;
      border-radius: 12px;
      box-shadow: 0 0 0 4px #23242a, 0 2px 12px 0 #0005;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-width: 56px;
      min-height: 56px;
      max-width: 96px;
      max-height: 96px;
      width: 72px;
      height: 72px;
      margin-right: 16px;
      overflow: hidden;
      animation: modal-popin 0.4s cubic-bezier(.68,-0.55,.27,1.55);
      flex-shrink: 0;
      border: 3px solid #444;
    }
    .light-mode #filePreviewArea .file-preview-box {
      background: #fff;
      box-shadow: 0 0 0 4px #e9ecef, 0 2px 12px 0 #0001;
      border: 3px solid #bbb;
    }
    #filePreviewArea .file-preview-img {
      border-radius: 10px;
      object-fit: contain;
      max-width: 100%;
      max-height: 88px;
      background: #181818;
      box-shadow: 0 1px 6px #0002;
      margin: 0 auto;
      display: block;
    }
    #filePreviewArea .file-preview-icon {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #1ed760;
      background: #181818;
      border-radius: 8px;
      font-size: 1.7em;
      margin: 0 auto 2px auto;
    }
    .light-mode #filePreviewArea .file-preview-icon {
      background: #f5f5f5;
      color: #1761a0;
    }
    #filePreviewArea .file-preview-name {
      font-size: 0.85em;
      color: #fff;
      max-width: 64px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      text-align: center;
      margin-top: 2px;
    }
    .light-mode #filePreviewArea .file-preview-name {
      color: #222;
    }
    #filePreviewArea .file-preview-remove {
      position: absolute;
      top: 4px;
      right: 6px;
      background: none;
      border: none;
      color: #ff5252;
      font-size: 1.1em;
      cursor: pointer;
      border-radius: 4px;
      padding: 1px 3px;
      transition: background 0.2s;
      z-index: 2;
    }
    #filePreviewArea .file-preview-remove:hover {
      background: #333;
    }
    .light-mode #filePreviewArea .file-preview-remove:hover {
      background: #e9ecef;
    }
    .sidebar {
      position: fixed;
      top: 0; left: 0; bottom: 0;
      width: 240px;
      background: #23242a;
      color: #fff;
      z-index: 20;
      display: flex;
      flex-direction: column;
      transition: width 0.2s cubic-bezier(.4,0,.2,1);
      box-shadow: 2px 0 12px 0 #0003;
    }
    .light-mode .sidebar { background: #f5f5f5; color: #222; }
    .sidebar.collapsed { width: 56px; }
    .sidebar.collapsed ~ #mainApp .ada-chat-container {
      width: calc(100vw - 56px);
      margin-left: 56px;
      transition: width 0.2s cubic-bezier(.4,0,.2,1), margin-left 0.2s cubic-bezier(.4,0,.2,1);
    }
    .sidebar-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 10px 12px 18px; font-weight: 600; font-size: 1.1em;
      border-bottom: 1px solid #333;
    }
    .light-mode .sidebar-header { border-bottom: 1px solid #ddd; }
    #sidebarToggle {
      background: none; border: none; color: #aaa; font-size: 1.2em; cursor: pointer; margin-left: 6px; margin-right: 2px;
    }
    #sidebarToggle:focus { outline: 2px solid #1ed760; }
    #newConversationBtn {
      background: #1ed760; color: #181818; border: none; border-radius: 6px; font-size: 1.1em; font-weight: bold; padding: 0 10px; cursor: pointer; margin-left: 6px;
    }
    #newConversationBtn:active { background: #19b84c; }
    .conversation-list {
      list-style: none; margin: 0; padding: 0; flex: 1 1 auto; overflow-y: auto;
    }
    .conversation-item {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #292a31;
      transition: background 0.15s;
      user-select: none;
    }
    .conversation-item.selected { background: #1ed76022; }
    .conversation-item:hover { background: #1ed76033; }
    .conversation-icon {
      width: 32px; height: 32px; border-radius: 50%; background: #1ed760; color: #181818; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1em;
    }
    .sidebar.collapsed .conversation-name { display: none; }
    .conversation-name {
      flex: 1 1 auto; font-size: 1em; font-weight: 500; color: #fff; background: none; border: none; outline: none; padding: 0; margin: 0;
    }
    .light-mode .conversation-name { color: #222; }
    .conversation-name.editing {
      background: #fff; color: #222; border-radius: 4px; padding: 2px 6px; border: 1px solid #bbb;
    }
    .conversation-icon.disabled-icon {
      filter: grayscale(1) brightness(0.7) !important;
      opacity: 0.6 !important;
    }
    /* Add CSS for conversation icon gradients and transitions */
    .conversation-icon.gradient {
      background: linear-gradient(135deg, #5b8cff 60%, #a259ff 100%) !important;
      color: #fff !important;
      transition: background 0.5s cubic-bezier(.4,0,.2,1), color 0.5s cubic-bezier(.4,0,.2,1), filter 0.5s cubic-bezier(.4,0,.2,1), opacity 0.5s cubic-bezier(.4,0,.2,1);
    }
    .conversation-icon.newchat-gradient {
      background: linear-gradient(135deg, #ffb86c 60%, #ff6ea0 100%) !important;
      color: #fff !important;
      transition: background 0.5s cubic-bezier(.4,0,.2,1), color 0.5s cubic-bezier(.4,0,.2,1), filter 0.5s cubic-bezier(.4,0,.2,1), opacity 0.5s cubic-bezier(.4,0,.2,1);
    }
    .conversation-icon.disabled-icon.gradient {
      background: linear-gradient(135deg, #e6e6e6 0%, #7a7a7a 100%) !important;
      color: #f2f2f2 !important;
      filter: grayscale(1) brightness(0.85) !important;
      opacity: 0.8 !important;
    }
    .conversation-icon.disabled-icon.newchat-gradient {
      background: linear-gradient(135deg, #f3e7d9 0%, #b08c7a 100%) !important;
      color: #f7f3f0 !important;
      filter: grayscale(1) brightness(0.92) !important;
      opacity: 0.8 !important;
    }
    @keyframes fade-to-gray {
      0% { filter: none; opacity: 1; }
      100% { filter: grayscale(1) brightness(0.85); opacity: 0.8; }
    }
    @keyframes fade-to-color {
      0% { filter: grayscale(1) brightness(0.85); opacity: 0.8; }
      100% { filter: none; opacity: 1; }
    }
    .conversation-icon.gradient {
      background: linear-gradient(135deg, #5b8cff 60%, #a259ff 100%) !important;
      color: #fff !important;
      transition: background 0.5s cubic-bezier(.4,0,.2,1), color 0.5s cubic-bezier(.4,0,.2,1);
      animation: fade-to-color 0.5s cubic-bezier(.4,0,.2,1);
    }
    .conversation-icon.newchat-gradient {
      background: linear-gradient(135deg, #ffb86c 60%, #ff6ea0 100%) !important;
      color: #fff !important;
      transition: background 0.5s cubic-bezier(.4,0,.2,1), color 0.5s cubic-bezier(.4,0,.2,1);
      animation: fade-to-color 0.5s cubic-bezier(.4,0,.2,1);
    }
    .conversation-icon.disabled-icon.gradient {
      background: linear-gradient(135deg, #e6e6e6 0%, #7a7a7a 100%) !important;
      color: #f2f2f2 !important;
      animation: fade-to-gray 0.5s cubic-bezier(.4,0,.2,1);
      filter: grayscale(1) brightness(0.85) !important;
      opacity: 0.8 !important;
    }
    .conversation-icon.disabled-icon.newchat-gradient {
      background: linear-gradient(135deg, #f3e7d9 0%, #b08c7a 100%) !important;
      color: #f7f3f0 !important;
      animation: fade-to-gray 0.5s cubic-bezier(.4,0,.2,1);
      filter: grayscale(1) brightness(0.92) !important;
      opacity: 0.8 !important;
    }
    .conversation-icon.fade-anim.gradient {
      animation: fade-to-color 0.5s cubic-bezier(.4,0,.2,1);
    }
    .conversation-icon.fade-anim.disabled-icon.gradient {
      animation: fade-to-gray 0.5s cubic-bezier(.4,0,.2,1);
    }
    .conversation-icon.fade-anim.newchat-gradient {
      animation: fade-to-color 0.5s cubic-bezier(.4,0,.2,1);
    }
    .conversation-icon.fade-anim.disabled-icon.newchat-gradient {
      animation: fade-to-gray 0.5s cubic-bezier(.4,0,.2,1);
    }
    @media (max-width: 600px) {
      .ada-chat-container {
        max-width: 100vw !important;
        width: 100vw !important;
        min-width: 0 !important;
        border-radius: 0 !important;
        padding-left: 0 !important;
        padding-right: 0 !important;
        margin-left: 0 !important;
        justify-content: flex-end !important;
        padding-bottom: 0 !important;
        padding-top: 0 !important;
        position: relative !important;
      }
      .circle-container {
        display: none !important;
      }
      .chat-window {
        max-width: 100vw !important;
        width: 100vw !important;
        border-radius: 0 !important;
        margin: 0 !important;
        position: fixed !important;
        top: 54px !important;
        left: 0 !important;
        bottom: 0 !important;
        height: calc(100vh - 54px) !important;
        z-index: 1 !important;
        background: rgba(34, 35, 42, 0.5) !important;
      }
      .light-mode .chat-window {
        background: rgba(255, 255, 255, 0.5) !important;
      }
      .sidebar {
        position: fixed !important;
        left: 0 !important;
        top: 0 !important;
        bottom: 0 !important;
        width: 80vw !important;
        max-width: 320px !important;
        min-width: 56px !important;
        z-index: 100 !important;
        box-shadow: 2px 0 12px 0 #0003 !important;
        transition: width 0.2s cubic-bezier(.4,0,.2,1), left 0.2s cubic-bezier(.4,0,.2,1);
      }
      .sidebar.collapsed {
        width: 0 !important;
        min-width: 0 !important;
        max-width: 0 !important;
        overflow: hidden !important;
        padding: 0 !important;
        border: none !important;
      }
      .sidebar.collapsed .sidebar-header,
      .sidebar.collapsed .conversation-list {
        display: none !important;
      }
      #sidebarToggle {
        position: fixed !important;
        left: 0 !important;
        top: 0 !important;
        z-index: 200 !important;
        background: #23242a !important;
        color: #fff !important;
        border-radius: 0 8px 8px 0 !important;
        box-shadow: 2px 0 8px #0003 !important;
        display: flex !important;
        width: 40px !important;
        height: 40px !important;
        align-items: center !important;
        justify-content: center !important;
        font-size: 1.5em !important;
        opacity: 1 !important;
        pointer-events: auto !important;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
  // Add/modify CSS for #attachBtn to make it blue and prominent
  const style = document.createElement('style');
  style.innerHTML = `
  #attachBtn {
    background: #2196f3 !important;
    border-radius: 8px !important;
    color: #fff !important;
    border: none !important;
    padding: 0 8px !important;
    margin-right: 8px !important;
    transition: background 0.2s, box-shadow 0.2s;
  }
  #attachBtn svg {
    stroke: #fff !important;
  }
  #attachBtn:hover {
    background: #1761a0 !important;
    box-shadow: 0 2px 8px #2196f355;
  }
  `;
  document.head.appendChild(style);
  // Add this CSS (in a <style> block or via JS):
  const iconStyle = document.createElement('style');
  iconStyle.innerHTML = `
  .conversation-icon.disabled-icon {
    filter: grayscale(1) brightness(0.7) !important;
    opacity: 0.6 !important;
  }
  `;
  document.head.appendChild(iconStyle);
  // Add CSS for conversation icon gradients and transitions
  const iconGradientStyle = document.createElement('style');
  iconGradientStyle.innerHTML = `
@keyframes fade-to-gray {
  0% { filter: none; opacity: 1; }
  100% { filter: grayscale(1) brightness(0.85); opacity: 0.8; }
}
@keyframes fade-to-color {
  0% { filter: grayscale(1) brightness(0.85); opacity: 0.8; }
  100% { filter: none; opacity: 1; }
}
.conversation-icon.gradient {
  background: linear-gradient(135deg, #5b8cff 60%, #a259ff 100%) !important;
  color: #fff !important;
  transition: background 0.5s cubic-bezier(.4,0,.2,1), color 0.5s cubic-bezier(.4,0,.2,1);
}
.conversation-icon.newchat-gradient {
  background: linear-gradient(135deg, #ffb86c 60%, #ff6ea0 100%) !important;
  color: #fff !important;
  transition: background 0.5s cubic-bezier(.4,0,.2,1), color 0.5s cubic-bezier(.4,0,.2,1);
}
.conversation-icon.disabled-icon.gradient {
  background: linear-gradient(135deg, #e6e6e6 0%, #7a7a7a 100%) !important;
  color: #f2f2f2 !important;
  filter: grayscale(1) brightness(0.85) !important;
  opacity: 0.8 !important;
}
.conversation-icon.disabled-icon.newchat-gradient {
  background: linear-gradient(135deg, #f3e7d9 0%, #b08c7a 100%) !important;
  color: #f7f3f0 !important;
  filter: grayscale(1) brightness(0.92) !important;
  opacity: 0.8 !important;
}
.conversation-icon.fade-anim.gradient {
  animation: fade-to-color 0.5s cubic-bezier(.4,0,.2,1);
}
.conversation-icon.fade-anim.disabled-icon.gradient {
  animation: fade-to-gray 0.5s cubic-bezier(.4,0,.2,1);
}
.conversation-icon.fade-anim.newchat-gradient {
  animation: fade-to-color 0.5s cubic-bezier(.4,0,.2,1);
}
.conversation-icon.fade-anim.disabled-icon.newchat-gradient {
  animation: fade-to-gray 0.5s cubic-bezier(.4,0,.2,1);
}
`;
  document.head.appendChild(iconGradientStyle);
  </script>
</head>
<body>
  <canvas id="particleBgCanvas" width="1920" height="1080"></canvas>
  <div id="loginContainer">
    <canvas id="loginBgCanvas" width="1920" height="1080"></canvas>
    <div class="login-box">
      <h2>Login</h2>
      <form id="loginForm" class="login-form-flex">
        <input type="text" id="loginUsername" placeholder="Username" autocomplete="username" required>
        <input type="password" id="loginPassword" placeholder="Password" autocomplete="current-password" required>
        <button type="submit">Log In</button>
      </form>
      <div id="loginError">Invalid credentials</div>
    </div>
  </div>
  <div id="sidebar" class="sidebar expanded">
    <div class="sidebar-header">
      <span>Conversations</span>
      <button id="sidebarToggle" title="Collapse sidebar">⮜</button>
      <button id="newConversationBtn" title="New conversation" style="display:none;">＋</button>
    </div>
    <ul id="conversationList" class="conversation-list"></ul>
  </div>
  <div id="mainApp" style="display: none;">
    <div class="ai-topbar" id="aiTopbar" style="display:none;">
      <div class="profile-menu" id="profileMenu">
        <div class="profile-userbox" id="profileUserBox">
          <div class="profile-avatar" id="profileAvatar"></div>
          <span class="profile-displayname" id="profileDisplayNameTop"></span>
        </div>
        <!-- Profile Modal Overlay -->
        <div class="profile-modal-overlay" id="profileModalOverlay">
          <div class="profile-modal">
            <button class="profile-modal-close" id="profileModalClose">✕</button>
            <div class="profile-modal-title">Account Settings</div>
            <div class="profile-modal-btns">
              <button class="profile-modal-btn" id="profileModalProfileBtn">Profile</button>
              <button class="profile-modal-btn" id="profileModalSecurityBtn">Account Security</button>
            </div>
            <button class="profile-modal-btn" id="profileModalLogoutBtn" style="margin-top: 18px; background: linear-gradient(90deg, #ff5252 60%, #1761a0 100%); color: #fff; width: 100%;">Log Out</button>
          </div>
          <!-- Profile Section Popups -->
          <div class="profile-section-modal" id="profileSectionProfile">
            <div class="profile-section-content">
              <button class="profile-section-back" id="profileSectionProfileBack">←</button>
              <div class="profile-section-title">Edit Profile</div>
              <form class="profile-section-form" id="profileSectionProfileForm">
                <label for="profileSectionDisplayName">Display Name</label>
                <input type="text" id="profileSectionDisplayName" maxlength="32" autocomplete="off">
                <button type="submit">Save</button>
                <div class="profile-section-success" id="profileSectionProfileSuccess" style="display:none; color: #1ed760;"></div>
                <div class="profile-section-error" id="profileSectionProfileError" style="display:none;"></div>
              </form>
            </div>
          </div>
          <div class="profile-section-modal" id="profileSectionSecurity">
            <div class="profile-section-content">
              <button class="profile-section-back" id="profileSectionSecurityBack">←</button>
              <div class="profile-section-title">Change Password</div>
              <form class="profile-section-form" id="profileSectionSecurityForm">
                <label for="profileSectionNewPassword">New Password</label>
                <input type="password" id="profileSectionNewPassword" placeholder="New Password" autocomplete="new-password">
                <button type="submit">Change Password</button>
                <div class="profile-section-success" id="profileSectionSecuritySuccess" style="display:none;"></div>
                <div class="profile-section-error" id="profileSectionSecurityError" style="display:none;"></div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="ada-chat-container">
      <div class="circle-container">
        <div class="pulse-outer" id="pulseOuter">
          <div class="pulse-inner-anim" id="pulseInnerAnim"></div>
          <div class="pulse-inner"></div>
        </div>
      </div>
      <div class="ai-status" id="aiStatus">AI Ready</div>
      <div class="chat-window">
        <div class="conversation-id" id="convId"></div>
        <div class="chat-topbar">
          <span class="chat-title">ADA Chat</span>
          <div class="topbar-buttons">
            <span style="color: #aaa; font-size: 0.9rem; margin-right: 8px;">Mode:</span>
            <select class="mode-dropdown" id="modeDropdown">
              <option value="text">Text Chat</option>
              <option value="image">Image Generation</option>
            </select>
            <button class="settings-btn" id="settingsBtn" title="Settings">
              <svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="3"/>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
              </svg>
            </button>
          </div>
        </div>
        <div class="messages" id="messages"></div>
        <div id="filePreviewArea" style="display:none;"></div>
        <form class="chat-input-row" id="chatForm" autocomplete="off">
          <input type="file" id="chatFileInput" style="display:none" multiple />
          <textarea class="chat-input" id="chatInput" placeholder="Talk to ADA..." autocomplete="off" style="flex:1 1 auto; min-width:0; resize:none; overflow:hidden; margin-right: 8px;" rows="1"></textarea>
          <button type="button" class="attach-btn" id="attachBtn" title="Attach file" style="margin-right:8px; background:none; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center;">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a5 5 0 0 1-7.07-7.07l9.19-9.19a3.5 3.5 0 0 1 4.95 4.95l-9.2 9.19a2 2 0 1 1-2.83-2.83l8.49-8.49"/></svg>
          </button>
          <button class="send-btn" id="sendBtn" type="submit">Send</button>
        </form>
      </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="settings-modal" id="settingsModal">
      <div class="settings-content">
        <div class="settings-header">
          <span class="settings-title">Settings</span>
          <button class="close-btn" id="closeSettings">✕</button>
        </div>
        <div class="theme-buttons">
          <div class="theme-btn dark" id="darkModeBtn">
            <div class="theme-preview">
              <div class="preview-bubble user"></div>
              <div class="preview-bubble ada"></div>
            </div>
            <p class="theme-label">Dark Mode</p>
          </div>
          <div class="theme-btn light" id="lightModeBtn">
            <div class="theme-preview">
              <div class="preview-bubble user"></div>
              <div class="preview-bubble ada"></div>
            </div>
            <p class="theme-label">Light Mode</p>
          </div>
        </div>
        <div class="pulse-toggle">
          <span class="theme-label">Pulse Animation</span>
          <div class="toggle-switch" id="pulseToggle"></div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Global variables - must be declared first
    let currentUser = null;
    let loginToken = null;
    
    // Cryptographically secure UUID v4 generator
    function uuidv4() {
      // Generate 16 random bytes using crypto.getRandomValues
      const array = new Uint8Array(16);
      crypto.getRandomValues(array);
      
      // Set version (4) and variant bits according to UUID v4 spec
      array[6] = (array[6] & 0x0f) | 0x40; // Version 4
      array[8] = (array[8] & 0x3f) | 0x80; // Variant bits
      
      // Convert to hex string and format with dashes
      const hex = Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
      return [
        hex.substring(0, 8),
        hex.substring(8, 12),
        hex.substring(12, 16),
        hex.substring(16, 20),
        hex.substring(20, 32)
      ].join('-');
    }
    
    // Helper function to convert data URL to blob
    function dataURLToBlob(dataURL) {
      const arr = dataURL.split(',');
      const mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while (n--) {
        u8arr[n] = bstr.charCodeAt(n);
      }
      return new Blob([u8arr], { type: mime });
    }
    let conversationId = uuidv4();
    function setConvIdText() {
      document.getElementById('convId').textContent = 'Conversation ID: ' + conversationId;
    }
    setConvIdText();
    const messagesDiv = document.getElementById('messages');
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const pulseOuter = document.getElementById('pulseOuter');
    const pulseInnerAnim = document.getElementById('pulseInnerAnim');
    const adaWaiting = document.getElementById('adaWaiting');
    const aiStatus = document.getElementById('aiStatus');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsModal = document.getElementById('settingsModal');
    const closeSettings = document.getElementById('closeSettings');
    const darkModeBtn = document.getElementById('darkModeBtn');
    const lightModeBtn = document.getElementById('lightModeBtn');
    const pulseToggle = document.getElementById('pulseToggle');
    const modeDropdown = document.getElementById('modeDropdown');
    let thinking = false;
    let messages = [];
    let statusInterval;
    let currentMode = 'text'; // Default mode
    
    // Settings state
    let isDarkMode = true;
    let isPulseEnabled = true;
    
    // Load settings from localStorage
    function loadSettings() {
      const savedDarkMode = localStorage.getItem('adaDarkMode');
      const savedPulse = localStorage.getItem('adaPulseEnabled');
      const savedMode = localStorage.getItem('adaMode');
      if (savedDarkMode !== null) isDarkMode = savedDarkMode === 'true';
      if (savedPulse !== null) isPulseEnabled = savedPulse === 'true';
      if (savedMode !== null) {
        currentMode = savedMode;
        modeDropdown.value = savedMode;
      }
      applySettings();
    }
    
    // Apply settings
    function applySettings() {
      if (isDarkMode) {
        document.body.classList.remove('light-mode');
        darkModeBtn.classList.add('active');
        lightModeBtn.classList.remove('active');
      } else {
        document.body.classList.add('light-mode');
        darkModeBtn.classList.remove('active');
        lightModeBtn.classList.add('active');
      }
      
      if (isPulseEnabled) {
        pulseOuter.classList.remove('no-pulse');
      } else {
        pulseOuter.classList.add('no-pulse');
      }
      
      // Update toggle states
      pulseToggle.classList.toggle('active', isPulseEnabled);
    }
    
    // Save settings
    function saveSettings() {
      localStorage.setItem('adaDarkMode', isDarkMode.toString());
      localStorage.setItem('adaPulseEnabled', isPulseEnabled.toString());
    }
    
    // Initialize settings
    loadSettings();
    
    // Settings event listeners
    settingsBtn.addEventListener('click', function() {
      settingsModal.classList.add('show');
    });
    
    // Mode dropdown event listener
    modeDropdown.addEventListener('change', function() {
      console.log('Mode switched from', currentMode, 'to', this.value);
      currentMode = this.value;
      localStorage.setItem('adaMode', currentMode);
    });
    
    closeSettings.addEventListener('click', function() {
      settingsModal.classList.remove('show');
    });
    
    settingsModal.addEventListener('click', function(e) {
      if (e.target === settingsModal) {
        settingsModal.classList.remove('show');
      }
    });
    
    darkModeBtn.addEventListener('click', function() {
      isDarkMode = true;
      applySettings();
      saveSettings();
    });
    
    lightModeBtn.addEventListener('click', function() {
      isDarkMode = false;
      applySettings();
      saveSettings();
    });
    
    pulseToggle.addEventListener('click', function() {
      isPulseEnabled = !isPulseEnabled;
      applySettings();
      saveSettings();
    });

    // Audio visualization
    let audioContext = null;
    let analyser = null;
    let audioSource = null;
    let audioElement = null;
    let isAudioPlaying = false;

    function animateAudio() {
      if (!isAudioPlaying || !analyser) return;
      
      const dataArray = new Uint8Array(analyser.frequencyBinCount);
      analyser.getByteFrequencyData(dataArray);
      
      // Calculate average frequency and volume
      let sum = 0;
      let count = 0;
      for (let i = 0; i < dataArray.length; i++) {
        sum += dataArray[i];
        count++;
      }
      const average = sum / count;
      
      // Inner circle scales based on audio wavelengths like existing animation
      const scale = 0.2 + (average / 255) * 0.5; // Scale from 0.2 to 0.7 based on audio
      pulseInnerAnim.style.width = `${scale * 100}px`;
      pulseInnerAnim.style.height = `${scale * 100}px`;
      
      requestAnimationFrame(animateAudio);
    }

    function playAudioFromAI(audioUrl) {
      console.log('playAudioFromAI called with', audioUrl);
      if (audioElement) {
        audioElement.pause();
        audioElement = null;
      }
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      audioElement = new Audio(audioUrl);
      audioElement.crossOrigin = 'anonymous';
      audioElement.onplay = function() {
        console.log('Audio is playing');
      };
      audioElement.onerror = function(e) {
        console.error('Audio playback error', e);
      };
      audioElement.onloadedmetadata = function() {
        try {
          if (audioSource) {
            audioSource.disconnect();
          }
          audioSource = audioContext.createMediaElementSource(audioElement);
          analyser = audioContext.createAnalyser();
          analyser.fftSize = 256;
          analyser.smoothingTimeConstant = 0.8;
          audioSource.connect(analyser);
          analyser.connect(audioContext.destination);
          audioContext.resume().then(() => {
            isAudioPlaying = true;
            console.log('AudioContext resumed, starting playback and animation');
            audioElement.play().then(() => {
              animateAudio();
            }).catch(err => {
              console.error('audioElement.play() failed', err);
            });
          });
        } catch (err) {
          console.error('Error setting up audio context', err);
        }
      };
      // In case metadata is already loaded
      if (audioElement.readyState >= 1) {
        audioElement.onloadedmetadata();
      }
    }
    
    // Simple Markdown to HTML parser (safe, basic)
    function parseMarkdown(md) {
      // Escape HTML
      md = md.replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
      // Code blocks
      md = md.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
      // Inline code
      md = md.replace(/`([^`]+)`/g, '<code>$1</code>');
      // Bold (apply before italic, non-greedy)
      md = md.replace(/\*\*([\s\S]+?)\*\*/g, '<strong>$1</strong>');
      // Italic (not inside bold)
      md = md.replace(/\*([^*\s][^*]*?)\*/g, '<em>$1</em>');
      // Blockquote
      md = md.replace(/^>\s?(.*)$/gm, '<blockquote>$1</blockquote>');
      // Links
      md = md.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
      // Unordered list
      md = md.replace(/^(\s*)[-*+] (.*)$/gm, '$1<ul><li>$2</li></ul>');
      // Ordered list
      md = md.replace(/^(\s*)\d+\. (.*)$/gm, '$1<ol><li>$2</li></ol>');
      // Headings
      md = md.replace(/^###### (.*)$/gm, '<h6>$1</h6>');
      md = md.replace(/^##### (.*)$/gm, '<h5>$1</h5>');
      md = md.replace(/^#### (.*)$/gm, '<h4>$1</h4>');
      md = md.replace(/^### (.*)$/gm, '<h3>$1</h3>');
      md = md.replace(/^## (.*)$/gm, '<h2>$1</h2>');
      md = md.replace(/^# (.*)$/gm, '<h1>$1</h1>');
      // Paragraphs
      md = md.replace(/\n{2,}/g, '</p><p>');
      md = '<p>' + md + '</p>';
      // Remove <p> around block elements
      md = md.replace(/<p>(<(?:ul|ol|pre|blockquote|h\d)[\s\S]*?<\/\w+>)<\/p>/g, '$1');
      return md;
    }

    // Smart markdown streaming function that renders complete elements immediately
    function smartMarkdownStream(currentText, finalText) {
      let processedText = currentText;
      
      // Find all complete markdown links in the final text
      const linkRegex = /\[([^\]]+)\]\(([^)]+)\)/g;
      const allLinks = [];
      let match;
      
      // Collect all complete links from the final text
      while ((match = linkRegex.exec(finalText)) !== null) {
        allLinks.push({
          fullMatch: match[0],
          text: match[1],
          url: match[2],
          startIndex: match.index,
          endIndex: match.index + match[0].length
        });
      }
      
      // Process each complete link
      allLinks.forEach(link => {
        // Check if this link is complete in the current text
        if (link.endIndex <= currentText.length) {
          // Replace the markdown syntax with HTML link
          processedText = processedText.replace(link.fullMatch, `<a href="${link.url}" target="_blank" rel="noopener">${link.text}</a>`);
        }
      });
      
      // Use marked.parse for the rest of the markdown processing
      return marked.parse(processedText);
    }

    // Update addMessage to use Markdown rendering
    function addMessage(message, isUser, opts) {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'message ' + (isUser ? 'user' : 'ada');
      if (isUser) {
        // Preserve line breaks for user messages
        msgDiv.innerHTML = message.trim().replace(/\n/g, '<br>');
      } else {
        // Configure marked to add target and rel attributes to links
      const renderer = new marked.Renderer();
      const linkRenderer = renderer.link;
      renderer.link = function(href, title, text) {
        const html = linkRenderer.call(renderer, href, title, text);
        return html.replace(/^<a /, '<a target="_blank" rel="noopener noreferrer" ');
      };
      
      msgDiv.innerHTML = '<div class="markdown">' + marked.parse(message, { renderer }) + '</div>';
        // Inject copy buttons into code blocks
        setTimeout(() => {
          const codeBlocks = msgDiv.querySelectorAll('pre > code');
          codeBlocks.forEach(code => {
            const pre = code.parentElement;
            // Prevent duplicate buttons
            if (pre.querySelector('.copy-code-btn')) return;
            const btn = document.createElement('button');
            btn.className = 'copy-code-btn';
            btn.type = 'button';
            btn.title = 'Copy code';
            btn.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" style="vertical-align:middle;margin-right:6px;">
                <rect x="4" y="3" width="12" height="14" rx="2" fill="#fff" stroke="#1ed760" stroke-width="1.5"/>
                <polyline points="13,3 16,3 16,7" fill="#eafff0" stroke="#1ed760" stroke-width="1.5"/>
                <path d="M16 7V5.5C16 4.12 14.88 3 13.5 3H6.5C5.12 3 4 4.12 4 5.5V14.5C4 15.88 5.12 17 6.5 17H13.5C14.88 17 16 15.88 16 14.5V13" stroke="#1ed760" stroke-width="1.5"/>
                <line x1="6" y1="7.5" x2="14" y2="7.5" stroke="#19b84c" stroke-width="1.5" stroke-linecap="round"/>
                <line x1="6" y1="10" x2="14" y2="10" stroke="#19b84c" stroke-width="1.5" stroke-linecap="round"/>
                <line x1="6" y1="12.5" x2="12" y2="12.5" stroke="#19b84c" stroke-width="1.5" stroke-linecap="round"/>
              </svg>
              <span style="vertical-align:middle;">Copy</span>
            `;
            btn.onclick = function(e) {
              e.stopPropagation();
              navigator.clipboard.writeText(code.textContent).then(() => {
                btn.innerHTML = `
                  <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"18\" height=\"18\" viewBox=\"0 0 20 20\" fill=\"none\" style=\"vertical-align:middle;margin-right:6px;\">
                    <rect x=\"4\" y=\"3\" width=\"12\" height=\"14\" rx=\"2\" fill=\"#fff\" stroke=\"#1ed760\" stroke-width=\"1.5\"/>
                    <polyline points=\"13,3 16,3 16,7\" fill=\"#eafff0\" stroke=\"#1ed760\" stroke-width=\"1.5\"/>
                    <path d=\"M16 7V5.5C16 4.12 14.88 3 13.5 3H6.5C5.12 3 4 4.12 4 5.5V14.5C4 15.88 5.12 17 6.5 17H13.5C14.88 17 16 15.88 16 14.5V13\" stroke=\"#1ed760\" stroke-width=\"1.5\"/>
                    <line x1=\"6\" y1=\"7.5\" x2=\"14\" y2=\"7.5\" stroke=\"#19b84c\" stroke-width=\"1.5\" stroke-linecap=\"round\"/>
                    <line x1=\"6\" y1=\"10\" x2=\"14\" y2=\"10\" stroke=\"#19b84c\" stroke-width=\"1.5\" stroke-linecap=\"round\"/>
                    <line x1=\"6\" y1=\"12.5\" x2=\"12\" y2=\"12.5\" stroke=\"#19b84c\" stroke-width=\"1.5\" stroke-linecap=\"round\"/>
                  </svg>
                  <span style=\"vertical-align:middle;\">Copied!</span>
                `;
                setTimeout(() => {
                  btn.innerHTML = `
                    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"18\" height=\"18\" viewBox=\"0 0 20 20\" fill=\"none\" style=\"vertical-align:middle;margin-right:6px;\">
                      <rect x=\"4\" y=\"3\" width=\"12\" height=\"14\" rx=\"2\" fill=\"#fff\" stroke=\"#1ed760\" stroke-width=\"1.5\"/>
                      <polyline points=\"13,3 16,3 16,7\" fill=\"#eafff0\" stroke=\"#1ed760\" stroke-width=\"1.5\"/>
                      <path d=\"M16 7V5.5C16 4.12 14.88 3 13.5 3H6.5C5.12 3 4 4.12 4 5.5V14.5C4 15.88 5.12 17 6.5 17H13.5C14.88 17 16 15.88 16 14.5V13\" stroke=\"#1ed760\" stroke-width=\"1.5\"/>
                      <line x1=\"6\" y1=\"7.5\" x2=\"14\" y2=\"7.5\" stroke=\"#19b84c\" stroke-width=\"1.5\" stroke-linecap=\"round\"/>
                      <line x1=\"6\" y1=\"10\" x2=\"14\" y2=\"10\" stroke=\"#19b84c\" stroke-width=\"1.5\" stroke-linecap=\"round\"/>
                      <line x1=\"6\" y1=\"12.5\" x2=\"12\" y2=\"12.5\" stroke=\"#19b84c\" stroke-width=\"1.5\" stroke-linecap=\"round\"/>
                    </svg>
                    <span style=\"vertical-align:middle;\">Copy</span>
                  `;
                }, 1200);
              });
            };
            pre.style.position = 'relative';
            btn.style.position = 'absolute';
            btn.style.top = '8px';
            btn.style.right = '12px';
            btn.style.background = '#fff';
            btn.style.color = '#1ed760';
            btn.style.border = '1.5px solid #1ed760';
            btn.style.borderRadius = '7px';
            btn.style.padding = '2px 12px 2px 8px';
            btn.style.fontSize = '0.97em';
            btn.style.fontWeight = '500';
            btn.style.cursor = 'pointer';
            btn.style.zIndex = '2';
            btn.style.display = 'flex';
            btn.style.alignItems = 'center';
            btn.style.boxShadow = '0 1px 6px #0001';
            btn.style.transition = 'background 0.2s, color 0.2s, border 0.2s';
            btn.onmouseenter = () => { btn.style.background = '#1ed760'; btn.style.color = '#23242a'; btn.style.borderColor = '#1ed760'; };
            btn.onmouseleave = () => { btn.style.background = '#fff'; btn.style.color = '#1ed760'; btn.style.borderColor = '#1ed760'; };
            pre.appendChild(btn);
          });
        }, 0);
      }
      messagesDiv.appendChild(msgDiv);
      setTimeout(() => { msgDiv.style.opacity = 1; msgDiv.style.transform = 'none'; }, 10);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      // Only push/save if not rendering history
      if (!opts || !opts.renderOnly) {
        messages.push({ text: message, isUser, timestamp: Date.now() });
        saveSessionData && saveSessionData();
        if (typeof conversations !== 'undefined' && conversations[currentConversationId]) {
          conversations[currentConversationId].messages = [...messages];
          conversations[currentConversationId].timestamp = Date.now();
          saveConversations && saveConversations();
          if (typeof renderConversationList === 'function') renderConversationList();
        }
      }
    }
    function setThinking(isThinking = true) {
      thinking = isThinking;
      if (isThinking) {
        pulseOuter.classList.add('thinking');
        pulseInnerAnim.classList.add('thinking');
        aiStatus.style.display = '';
        startStatusAnim();
        // Send button loading effect
        sendBtn.classList.add('login-btn-loading');
        sendBtn.disabled = true;
        if (typeof renderConversationList === 'function') renderConversationList();
        // Add fade-anim to all icons
        document.querySelectorAll('.conversation-icon').forEach(icon => {
          icon.classList.add('fade-anim');
        });
      } else {
        pulseOuter.classList.remove('thinking');
        pulseInnerAnim.classList.remove('thinking');
        stopStatusAnim();
        // Remove send button loading effect
        sendBtn.classList.remove('login-btn-loading');
        sendBtn.disabled = false;
        if (!aiStatus.classList.contains('error-status')) {
          aiStatus.textContent = 'AI Ready';
        }
        if (typeof renderConversationList === 'function') renderConversationList();
        // Add fade-anim to all icons
        document.querySelectorAll('.conversation-icon').forEach(icon => {
          icon.classList.add('fade-anim');
        });
        // Remove fade-anim after animation
        setTimeout(() => {
          document.querySelectorAll('.conversation-icon').forEach(icon => {
            icon.classList.remove('fade-anim');
          });
        }, 600);
      }
    }
    function setOffline() {
      pulseOuter.classList.remove('thinking');
      pulseOuter.classList.add('offline');
      pulseInnerAnim.classList.remove('thinking');
      pulseInnerAnim.classList.add('offline');
      sendBtn.disabled = true;
      chatInput.disabled = true;
      aiStatus.style.display = 'none';
    }
    function setOnline() {
      pulseOuter.classList.remove('offline');
      pulseInnerAnim.classList.remove('offline');
      sendBtn.disabled = false;
      chatInput.disabled = false;
      aiStatus.style.display = '';
    }
    function startStatusAnim() {
      let dots = 0;
      stopStatusAnim();
      aiStatus.style.display = '';
      aiStatus.classList.add('thinking-status');
      statusInterval = setInterval(() => {
        dots = (dots + 1) % 3;
        aiStatus.textContent = 'Thinking' + '.'.repeat(dots + 1);
      }, 500);
    }
    function stopStatusAnim() {
      clearInterval(statusInterval);
      aiStatus.classList.remove('thinking-status');
      if (!aiStatus.classList.contains('error-status')) {
        aiStatus.textContent = 'AI Ready';
      }
    }
    function setErrorState() {
      thinking = false; // Reset thinking state when error occurs
      pulseOuter.classList.remove('thinking', 'offline');
      pulseOuter.classList.add('error');
      pulseInnerAnim.classList.remove('thinking', 'offline');
      pulseInnerAnim.classList.add('error');
      aiStatus.style.display = '';
      aiStatus.classList.add('error-status');
      aiStatus.textContent = 'Error Occurred';
      sendBtn.disabled = true;
      chatInput.disabled = true;
    }
    chatForm.addEventListener('submit', async function (e) {
      e.preventDefault();
      clearErrorState();
      if ((!chatInput.value.trim() && attachedFiles.length === 0) || thinking) return;
      setThinking(true);
      const userText = chatInput.value; // Don't trim to preserve formatting
      if (userText.trim()) addMessage(userText, true);
      // Store the message for potential retry, but clear the input for better UX
      const messageToRetry = userText;
      chatInput.value = '';
      autoResizeTextarea(); // Reset textarea height
      // Show file sent message in chat
      let filesToSend = [];
      if (attachedFiles.length > 0) {
        filesToSend = [...attachedFiles];
        attachedFiles.forEach(f => {
          if (f.type.startsWith('image/')) {
            addImageMessage(f);
          } else {
            addFileMessage(f);
          }
        });
        clearFilePreviews();
      }
      try {
        let res;
        if (filesToSend.length > 0) {
          // Build message with file names and template reference
          let fileRefs = filesToSend.map(f => `File: ${f.name} ({{ $('Webhook').item.json.body.message }})`).join('\n');
          let fullMessage = userText ? `${userText}\n${fileRefs}` : fileRefs;
          // Send as multipart/form-data
          const formData = new FormData();
          filesToSend.forEach(f => formData.append('file', f));
          formData.append('message', fullMessage);
          formData.append('conversationId', conversationId);
          formData.append('user', getCookie('ada_current_user'));
          formData.append('mode', currentMode);
          formData.append('loginToken', getCookie('ada_login_token'));
          res = await fetch('https://n8n.tail851803.ts.net/webhook/8c65cdd1-4ace-49eb-ab59-c9666cb0fc41', {
            method: 'POST',
            body: formData
          });
        } else {
          // Send as JSON
          res = await fetch('https://n8n.tail851803.ts.net/webhook/8c65cdd1-4ace-49eb-ab59-c9666cb0fc41', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: userText, conversationId, user: getCookie('ada_current_user'), mode: currentMode, loginToken: getCookie('ada_login_token') })
          });
        }

        chatFileInput.value = '';

        // Check response content type first to determine how to handle it
        const contentType = res.headers.get('content-type') || '';
        console.log('Response content type:', contentType);
        
        // Check if it's likely a binary image response
        if (contentType.startsWith('image/')) {
          console.log('Binary image response detected - processing as binary');
          const responseBuffer = await res.arrayBuffer();
          const responseArray = new Uint8Array(responseBuffer);
          
          // Check if response contains binary data (PNG, JPEG, etc.)
          const binaryPatterns = {
            png: [0x89, 0x50, 0x4E, 0x47], // PNG header
            jpeg: [0xFF, 0xD8, 0xFF], // JPEG header
            gif: [0x47, 0x49, 0x46, 0x38], // GIF header
            webp: [0x52, 0x49, 0x46, 0x46], // WebP header (RIFF)
            bmp: [0x42, 0x4D] // BMP header
          };
          
          let isBinaryImage = false;
          let imageType = null;
          
          console.log('Checking for binary image data...');
          console.log('Response array length:', responseArray.length);
          
          // Check for binary image data by comparing first few bytes
          for (const [type, pattern] of Object.entries(binaryPatterns)) {
            if (responseArray.length >= pattern.length) {
              const matches = pattern.every((byte, index) => responseArray[index] === byte);
              if (matches) {
                isBinaryImage = true;
                imageType = type;
                console.log(`Binary image detected: ${type}`);
                break;
              }
            }
          }
          
          if (isBinaryImage && imageType) {
            // Create blob directly from the ArrayBuffer
            const blob = new Blob([responseBuffer], { type: `image/${imageType}` });
            const blobUrl = URL.createObjectURL(blob);
            
            // Create a file-like object for the image display
            const imageFile = {
              name: `ai_generated_image.${imageType}`,
              type: `image/${imageType}`,
              _blobUrl: blobUrl,
              _blob: blob // Pass the actual blob for base64 conversion
            };
            
            // Display the binary image using a special AI image display function
            addAIImageMessage(imageFile, { renderOnly: false });
            setOnline();
            // Clear file previews on successful response
            clearFilePreviews();
            setThinking(false);
            return; // Exit early since we've handled the binary response
          }
        }
        
        // If not binary image, read as text to check for iframe content
        const responseText = await res.text();
        console.log('Raw response:', responseText);
        console.log('Response length:', responseText.length);
        console.log('Contains iframe tag:', responseText.includes('<iframe'));
        console.log('Contains srcdoc attribute:', responseText.includes('srcdoc='));
        
        // Check if response contains iframe content
        if (responseText.includes('<iframe') && responseText.includes('srcdoc=')) {
          console.log('Response contains iframe - processing iframe content');
          
          // Extract the iframe content
          const iframeMatch = responseText.match(/<iframe[^>]*srcdoc=["']([^"']+)["']/i);
          console.log('Iframe regex match result:', iframeMatch);
          if (iframeMatch) {
            const iframeContent = iframeMatch[1];
            console.log('Extracted iframe content:', iframeContent);
            console.log('Iframe content length:', iframeContent.length);
            
            // Display the iframe response with streaming typing effect
            if (iframeContent.trim()) {
              // Create a temporary message div for the streaming effect
              const tempMsgDiv = document.createElement('div');
              tempMsgDiv.className = 'message ada';
              tempMsgDiv.innerHTML = '<div class="markdown">';
              tempMsgDiv.style.opacity = '0';
              tempMsgDiv.style.transform = 'translateY(20px)';
              messagesDiv.appendChild(tempMsgDiv);
              
              // Animate the message appearing
              setTimeout(() => {
                tempMsgDiv.style.opacity = '1';
                tempMsgDiv.style.transform = 'none';
              }, 10);
              
              // Type out the response character by character
              let currentText = '';
              const finalText = iframeContent.trim().replace(/\n+$/, ''); // Remove trailing newlines
              const typingSpeed = 5; // milliseconds per character - super fast like ChatGPT
              
              const typeWriter = () => {
                if (currentText.length < finalText.length) {
                  currentText += finalText[currentText.length];
                  tempMsgDiv.querySelector('.markdown').innerHTML = smartMarkdownStream(currentText, finalText);
                  messagesDiv.scrollTop = messagesDiv.scrollHeight;
                  setTimeout(typeWriter, typingSpeed);
                }
                // No completion effect - just finish typing
              };
              
              // Start the typing effect
              typeWriter();
              
              // Add the message to the messages array for persistence
              messages.push({ text: finalText, isUser: false, timestamp: Date.now() });
              // Update conversation data
              if (typeof conversations !== 'undefined' && conversations[currentConversationId]) {
                conversations[currentConversationId].messages = [...messages];
                conversations[currentConversationId].timestamp = Date.now();
                saveConversations();
              }
              saveSessionData && saveSessionData();
              
            } else {
              console.log('Iframe content is empty');
              addMessage('[No response]', false);
            }
          } else {
            console.log('Failed to extract iframe content from response');
            addMessage('[Error: Could not parse iframe response]', false);
          }
        } else {
          console.log('Processing non-iframe text response');
          // Process the text response with streaming typing effect
          const adaText = responseText;
          console.log('Non-iframe response detected - processing as regular text');
          console.log('Raw non-iframe response:', adaText);
          
          // Process the text response
          let displayText = adaText.trim();
          
          // Decode HTML entities without using innerHTML to avoid apostrophe issues
          displayText = displayText
            .replace(/&amp;/g, '&')
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .replace(/&quot;/g, '"')
            .replace(/&#x27;/g, "'")
            .replace(/&#39;/g, "'")
            .replace(/&apos;/g, "'");
          displayText = displayText.trim();
          
          // Remove trailing newlines from AI response
          displayText = displayText.replace(/\n+$/, '');
          
          // Debug: log the processed displayText
          console.log('Processed non-iframe AI message:', displayText);
          
          // Display the response with streaming typing effect
          if (displayText.trim()) {
            // Create a temporary message div for the streaming effect
            const tempMsgDiv = document.createElement('div');
            tempMsgDiv.className = 'message ada';
            tempMsgDiv.innerHTML = '<div class="markdown">';
            tempMsgDiv.style.opacity = '0';
            tempMsgDiv.style.transform = 'translateY(20px)';
            messagesDiv.appendChild(tempMsgDiv);
            
            // Animate the message appearing
            setTimeout(() => {
              tempMsgDiv.style.opacity = '1';
              tempMsgDiv.style.transform = 'none';
            }, 10);
            
            // Type out the response character by character
            let currentText = '';
            const finalText = displayText.trim().replace(/\n+$/, ''); // Remove trailing newlines
            const typingSpeed = 5; // milliseconds per character - super fast like ChatGPT
            
            const typeWriter = () => {
              if (currentText.length < finalText.length) {
                currentText += finalText[currentText.length];
                tempMsgDiv.querySelector('.markdown').innerHTML = smartMarkdownStream(currentText, finalText);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                setTimeout(typeWriter, typingSpeed);
              }
              // No completion effect - just finish typing
            };
            
            // Start the typing effect
            typeWriter();
            
            // Add the message to the messages array for persistence
            messages.push({ text: finalText, isUser: false, timestamp: Date.now() });
            // Update conversation data
            if (typeof conversations !== 'undefined' && conversations[currentConversationId]) {
              conversations[currentConversationId].messages = [...messages];
              conversations[currentConversationId].timestamp = Date.now();
              saveConversations();
            }
            saveSessionData && saveSessionData();
            
          } else {
            addMessage('[No response]', false);
          }

          // If backend returns a file URL, show a download link
          const urlMatch = displayText.match(/(https?:\/\/\S+\.(?:pdf|docx?|xlsx?|png|jpe?g|gif|txt|csv|zip|rar|mp3|mp4|wav|webm|json|xml|pptx?))/i);
          if (urlMatch) {
            // Add download link to the streaming message
            const downloadLink = `📎 <a href="${urlMatch[1]}" target="_blank" rel="noopener">Download file</a>`;
            // Note: Download links will appear in the streaming message as it types out
          }
        }
        setOnline();
        // Clear file previews on successful response
        clearFilePreviews();
      } catch (error) {
        console.error('Error contacting ADA:', error);
        console.log('Current mode during error:', currentMode);
        console.log('Current conversation ID:', currentConversationId);
        console.log('Messages count:', messages.length);
        setErrorState();
        // Restore the message to input field for retry
        if (messageToRetry) {
          chatInput.value = messageToRetry;
          autoResizeTextarea(); // Resize textarea when restoring message
        }
        // Save conversation even when error occurs to preserve user message
        if (typeof conversations !== 'undefined' && conversations[currentConversationId]) {
          conversations[currentConversationId].messages = [...messages];
          conversations[currentConversationId].timestamp = Date.now();
          saveConversations && saveConversations();
          console.log('Conversation saved after error');
        }
      }
      setThinking(false);
    });
    // Microanimation: input focus glow
    chatInput.addEventListener('focus', function() {
      chatInput.style.boxShadow = '0 0 0 2px #1ed76088';
    });
    chatInput.addEventListener('blur', function() {
      chatInput.style.boxShadow = '';
    });
    // Microanimation: send button pop
    sendBtn.addEventListener('mousedown', function() {
      sendBtn.style.transform = 'scale(0.96)';
    });
    sendBtn.addEventListener('mouseup', function() {
      sendBtn.style.transform = '';
    });
    sendBtn.addEventListener('mouseleave', function() {
      sendBtn.style.transform = '';
    });
    // Auto-resize textarea function
    function autoResizeTextarea() {
      const textarea = chatInput;
      textarea.style.height = 'auto';
      
      // Calculate the height based on content
      const scrollHeight = textarea.scrollHeight;
      const maxHeight = 100; // 4 lines approximately (25px per line)
      
      if (scrollHeight <= maxHeight) {
        textarea.style.height = Math.max(20, scrollHeight) + 'px';
        textarea.style.overflowY = 'hidden';
      } else {
        textarea.style.height = maxHeight + 'px';
        textarea.style.overflowY = 'auto';
      }
    }

    // Handle Shift+Enter for line breaks, Enter for sending
    chatInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && thinking) {
        e.preventDefault();
        return;
      }
      
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        // Submit the form
        chatForm.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
      }
      // Shift+Enter is allowed for line breaks (default behavior)
    });

    // Auto-resize on input
    chatInput.addEventListener('input', autoResizeTextarea);
    
    // Initial resize
    autoResizeTextarea();
    // Animate the inner circle size
    let animStart = null;
    function animateInnerCircle(ts) {
      if (!animStart) animStart = ts;
      const t = ((ts - animStart) / 2000) % 1; // 2s period
      // Use a smooth sine wave for size
      const min = 32, max = 112; // px (32px = white, 112px = 3.5/5 of 160px)
      const s = min + (max - min) * (0.5 + 0.5 * Math.sin(t * 2 * Math.PI));
      pulseInnerAnim.style.width = s + 'px';
      pulseInnerAnim.style.height = s + 'px';
      requestAnimationFrame(animateInnerCircle);
    }
    requestAnimationFrame(animateInnerCircle);

    // Login system
    const loginContainer = document.getElementById('loginContainer');
    const mainApp = document.getElementById('mainApp');
    const loginForm = document.getElementById('loginForm');
    const loginError = document.getElementById('loginError');
    let displayName = '';
    let loginAttempts = 0;
    let lastLoginAttempt = 0;
    const MAX_LOGIN_ATTEMPTS = 5;
    const LOGIN_TIMEOUT = 5 * 60 * 1000; // 5 minutes in milliseconds

    // Rate limiting function
    function checkRateLimit() {
      const now = Date.now();
      if (loginAttempts >= MAX_LOGIN_ATTEMPTS) {
        if (now - lastLoginAttempt < LOGIN_TIMEOUT) {
          const minutesLeft = Math.ceil((LOGIN_TIMEOUT - (now - lastLoginAttempt)) / 60000);
          loginError.textContent = `Too many login attempts. Please try again in ${minutesLeft} minutes.`;
          loginError.style.display = 'block';
          return false;
        } else {
          // Reset after timeout
          loginAttempts = 0;
        }
      }
      return true;
    }

    loginForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      const loginBtn = loginForm.querySelector('button[type="submit"]');
      // Check rate limit
      if (!checkRateLimit()) {
        return;
      }

      // Set loading state
      loginBtn.classList.add('login-btn-loading');
      loginBtn.disabled = true;

      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;

      // Increment login attempts
      loginAttempts++;
      lastLoginAttempt = Date.now();

      try {
        const res = await fetch('https://n8n.tail851803.ts.net/webhook/3d4cf879-7972-4ee6-a25a-ef0eac8cf3a6', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        let loginResult = await res.text();
        const iframeMatch = loginResult.match(/<iframe[^>]*srcdoc=["']([^"']+)["']/i);
        if (iframeMatch) {
          loginResult = iframeMatch[1];
        } else {
          // Use DOM to decode HTML entities and strip tags
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = loginResult;
          loginResult = tempDiv.textContent || tempDiv.innerText || '';
          loginResult = loginResult.trim();
        }
        loginResult = loginResult.trim().toLowerCase();
        if (loginResult === 'true') {
          // Reset login attempts on success
          loginAttempts = 0;

          try {
            const displayNameRes = await fetch('https://n8n.tail851803.ts.net/webhook/704868e1-ec37-4b03-b5f9-2461ad546d6c', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ user: username })
            });
            let displayNameText = await displayNameRes.text();
            const dnIframeMatch = displayNameText.match(/<iframe[^>]*srcdoc=["']([^"']+)["']/i);
            if (dnIframeMatch) {
              displayNameText = dnIframeMatch[1];
            } else {
              // Use DOM to decode HTML entities and strip tags
              const tempDiv = document.createElement('div');
              tempDiv.innerHTML = displayNameText;
              displayNameText = tempDiv.textContent || tempDiv.innerText || '';
              displayNameText = displayNameText.trim();
            }
            displayName = displayNameText.trim();
            if (displayName) {
              currentUser = username;
              // Save user session and conversation data to cookies
              saveSessionData();
              // Set persistent login cookie
              const adaCookieValue = JSON.stringify({user: username, displayName: displayName});
              document.cookie = `adaCurrentUser=${encodeURIComponent(adaCookieValue)}; path=/; max-age=604800`;
              console.debug('[ADA] Created adaCurrentUser cookie:', adaCookieValue);
              loginContainer.style.display = 'none';
              mainApp.style.display = '';
              var aiTopbar = document.getElementById('aiTopbar');
              if (aiTopbar) aiTopbar.style.display = '';
              updateProfileTopbar();
              // Load only this user's conversations
              loadConversations();
              currentConversationId = null;
              renderConversationList();
              switchConversation(null);
              // Always reset login button after successful login
              loginBtn.classList.remove('login-btn-loading');
              loginBtn.disabled = false;
            } else {
              if (!isLoggingOut) {
                loginError.textContent = 'Failed to fetch display name.';
                loginError.style.display = 'block';
              }
              // Remove loading state
              loginBtn.classList.remove('login-btn-loading');
              loginBtn.disabled = false;
            }
          } catch (err) {
            if (!isLoggingOut) {
              loginError.textContent = 'Failed to fetch display name.';
              loginError.style.display = 'block';
            }
            // Remove loading state
            loginBtn.classList.remove('login-btn-loading');
            loginBtn.disabled = false;
          }
        } else {
          loginError.textContent = 'Invalid credentials.';
          loginError.style.display = 'block';
          // Remove loading state
          loginBtn.classList.remove('login-btn-loading');
          loginBtn.disabled = false;
        }
      } catch (err) {
        loginError.textContent = 'Login failed. Please try again.';
        loginError.style.display = 'block';
        // Remove loading state
        loginBtn.classList.remove('login-btn-loading');
        loginBtn.disabled = false;
      }
    });

    // Cookie management functions
    function saveSessionData() {
      // Save all conversations for the user (for future extensibility)
      let conversations = {};
      // Try to load existing conversations from cookie
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        const idx = cookie.indexOf('=');
        if (idx === -1) continue;
        const name = cookie.slice(0, idx).trim();
        const value = cookie.slice(idx + 1);
        if (name === 'sessionData') {
          try {
            const sessionData = JSON.parse(decodeURIComponent(value));
            if (sessionData.conversations) {
              conversations = sessionData.conversations;
            }
          } catch {}
        }
      }
      conversations[conversationId] = {
        messages,
        timestamp: Date.now()
      };
      const sessionData = {
        currentUser,
        displayName,
        conversations
      };
      document.cookie = `sessionData=${encodeURIComponent(JSON.stringify(sessionData))}; path=/`;
    }

    function loadSessionData() {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        const idx = cookie.indexOf('=');
        if (idx === -1) continue;
        const name = cookie.slice(0, idx).trim();
        const value = cookie.slice(idx + 1);
        if (name === 'sessionData') {
          try {
            const sessionData = JSON.parse(decodeURIComponent(value));
            if (!sessionData.currentUser) return false;
            currentUser = sessionData.currentUser;
            displayName = sessionData.displayName;
            if (sessionData.conversations) {
              // Don't restore last conversation - always start with new chat
              // Just load the conversations data but don't switch to any specific conversation
              conversations = sessionData.conversations;
              currentConversationId = null;
              conversationId = null;
              messages = [];
              // Update the conversation list to show "New Chat" selected
              if (typeof renderConversationList === 'function') {
                renderConversationList();
              }
            }
            return true;
          } catch (err) {
            console.error('Error parsing session data');
          }
        }
      }
      return false;
    }

    // Update displayMessages to call addMessage with renderOnly: true
    function displayMessages() {
      messagesDiv.innerHTML = '';
      messages.forEach(msg => {
        if (msg.text && msg.text.startsWith('[Image] ')) {
          // Fake a File object for rendering
          addImageMessage({ name: msg.text.replace('[Image] ', ''), _blobUrl: msg._blobUrl }, { renderOnly: true });
        } else if (msg.text && msg.text.startsWith('[AI Image] ')) {
          // Fake a File object for rendering AI-generated images
          console.log('Loading AI image message:', msg.text, 'has _imageData:', !!msg._imageData, 'has _blobUrl:', !!msg._blobUrl);
          if (msg._imageData) {
            // Use base64 data if available (for persisted images)
            const blob = dataURLToBlob(msg._imageData);
            const blobUrl = URL.createObjectURL(blob);
            addAIImageMessage({ 
              name: msg.text.replace('[AI Image] ', ''), 
              _blobUrl: blobUrl,
              type: msg._imageType || 'image/png'
            }, { renderOnly: true });
          } else {
            // Fallback to blob URL (for current session)
            addAIImageMessage({ name: msg.text.replace('[AI Image] ', ''), _blobUrl: msg._blobUrl }, { renderOnly: true });
          }
        } else if (msg.text && msg.text.startsWith('[File] ')) {
          addFileMessage({ name: msg.text.replace('[File] ', '') }, { renderOnly: true });
        } else {
          addMessage(msg.text, msg.isUser, { renderOnly: true });
        }
      });
    }

    // Check for existing session on page load
    window.addEventListener('DOMContentLoaded', function() {
      // Check adaCurrentUser cookie
      const cookies = document.cookie.split(';');
      let foundUser = '';
      let foundDisplayName = '';
      let foundConversationId = null;
      let foundConversations = null;
      for (let cookie of cookies) {
        const idx = cookie.indexOf('=');
        if (idx === -1) continue;
        const name = cookie.slice(0, idx).trim();
        const value = cookie.slice(idx + 1);
        if (name === 'adaCurrentUser') {
          try {
            const parsed = JSON.parse(decodeURIComponent(value));
            foundUser = parsed.user;
            foundDisplayName = parsed.displayName;
          } catch {
            foundUser = decodeURIComponent(value);
            foundDisplayName = '';
          }
        }
        if (name === 'sessionData') {
          try {
            const sessionData = JSON.parse(decodeURIComponent(value));
            if (sessionData.currentUser) {
              foundConversationId = sessionData.currentConversationId || null;
              foundConversations = sessionData.conversations || null;
            }
          } catch {}
        }
      }
      if (foundUser) {
        currentUser = foundUser;
        displayName = foundDisplayName;
        loginContainer.style.display = 'none';
        mainApp.style.display = '';
        var aiTopbar = document.getElementById('aiTopbar');
        if (aiTopbar) aiTopbar.style.display = '';
        updateProfileTopbar();
        // Load conversations for this user
        loadConversations();
        // Always start with new chat on refresh
        if (foundConversations) {
          conversations = foundConversations;
        }
        currentConversationId = null;
        renderConversationList();
        switchConversation(null);
      } else if (loadSessionData()) {
        loginContainer.style.display = 'none';
        mainApp.style.display = '';
        var aiTopbar = document.getElementById('aiTopbar');
        if (aiTopbar) aiTopbar.style.display = '';
        updateProfileTopbar();
      } else {
        loginContainer.style.display = '';
        mainApp.style.display = 'none';
      }
      // Attach image modal close button event
      var imageModalCloseBtn = document.getElementById('imageModalClose');
      if (imageModalCloseBtn) {
        imageModalCloseBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          document.getElementById('imageModal').style.display = 'none';
          document.getElementById('imageModalImg').src = '';
        });
      }
    });

    // Show topbar only after login
    function showTopbar() {
      document.getElementById('aiTopbar').style.display = '';
      document.getElementById('profileUsername').textContent = currentUser;
      updateProfileTopbar();
      document.getElementById('profileDisplayName').value = displayName || currentUser;
    }

    // Profile modal logic
    const profileModalOverlay = document.getElementById('profileModalOverlay');
    const profileModalClose = document.getElementById('profileModalClose');
    const profileModalProfileBtn = document.getElementById('profileModalProfileBtn');
    const profileModalSecurityBtn = document.getElementById('profileModalSecurityBtn');
    const profileDisplayNameTop = document.getElementById('profileDisplayNameTop');
    const profileModalLogoutBtn = document.getElementById('profileModalLogoutBtn');
    // Section popups
    const profileSectionProfile = document.getElementById('profileSectionProfile');
    const profileSectionProfileBack = document.getElementById('profileSectionProfileBack');
    const profileSectionProfileForm = document.getElementById('profileSectionProfileForm');
    const profileSectionDisplayName = document.getElementById('profileSectionDisplayName');
    const profileSectionProfileSuccess = document.getElementById('profileSectionProfileSuccess');
    const profileSectionProfileError = document.getElementById('profileSectionProfileError');
    const profileSectionSecurity = document.getElementById('profileSectionSecurity');
    const profileSectionSecurityBack = document.getElementById('profileSectionSecurityBack');
    const profileSectionSecurityForm = document.getElementById('profileSectionSecurityForm');
    const profileSectionNewPassword = document.getElementById('profileSectionNewPassword');
    const profileSectionSecuritySuccess = document.getElementById('profileSectionSecuritySuccess');
    const profileSectionSecurityError = document.getElementById('profileSectionSecurityError');

    // Open modal on avatar or name click
    document.getElementById('profileUserBox').addEventListener('click', function(e) {
      profileModalOverlay.classList.add('show');
      e.stopPropagation();
    });
    // Close modal on close button or clicking overlay
    profileModalClose.addEventListener('click', function() {
      profileModalOverlay.classList.remove('show');
    });
    profileModalOverlay.addEventListener('click', function(e) {
      if (e.target === profileModalOverlay) {
        profileModalOverlay.classList.remove('show');
      }
    });
    // Show profile section popup
    profileModalProfileBtn.addEventListener('click', function() {
      profileSectionProfile.classList.add('show');
      profileSectionDisplayName.value = displayName || currentUser;
      profileSectionProfileSuccess.style.display = 'none';
      profileSectionProfileError.style.display = 'none';
    });
    // Show security section popup
    profileModalSecurityBtn.addEventListener('click', function() {
      profileSectionSecurity.classList.add('show');
      profileSectionNewPassword.value = '';
      profileSectionSecuritySuccess.style.display = 'none';
      profileSectionSecurityError.style.display = 'none';
    });
    // Back buttons for popups
    profileSectionProfileBack.addEventListener('click', function() {
      profileSectionProfile.classList.remove('show');
    });
    profileSectionSecurityBack.addEventListener('click', function() {
      profileSectionSecurity.classList.remove('show');
    });
    // Profile form submit
    profileSectionProfileForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      const newDisplayName = profileSectionDisplayName.value.trim();
      if (!newDisplayName) {
        profileSectionProfileError.textContent = 'Display name cannot be empty.';
        profileSectionProfileError.style.display = '';
        profileSectionProfileSuccess.style.display = 'none';
        return;
      }
      profileSectionProfileError.style.display = 'none';
      profileSectionProfileSuccess.style.display = 'none';
      try {
        const res = await fetch('https://n8n.tail851803.ts.net/webhook/19fc6ca8-b869-40a3-aa4b-ffbc927214d7', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            user: getCookie('ada_current_user'), 
            currentDisplayName: displayName, 
            newDisplayName: newDisplayName 
          })
        });
        let result = await res.text();
        // Remove iframe wrapping if present
        const iframeMatch = result.match(/<iframe[^>]*srcdoc=["']([^"']+)["']/i);
        if (iframeMatch) {
          result = iframeMatch[1];
        } else {
          result = result.replace(/<[^>]+>/g, '').trim();
        }
        if (result.toLowerCase().includes('success')) {
          displayName = newDisplayName;
          document.getElementById('profileDisplayNameTop').textContent = displayName;
          updateProfileTopbar();
          profileSectionProfileSuccess.textContent = 'Display name changed successfully';
          profileSectionProfileSuccess.style.display = 'block';
          profileSectionProfileError.style.display = 'none';
          saveSessionData();
          // Update persistent login cookie with new display name
          const adaCookieValue2 = JSON.stringify({user: currentUser, displayName: displayName});
          document.cookie = `adaCurrentUser=${encodeURIComponent(adaCookieValue2)}; path=/; max-age=604800`;
          console.debug('[ADA] Updated adaCurrentUser cookie:', adaCookieValue2);
        } else {
          profileSectionProfileError.textContent = result || 'Failed to update display name.';
          profileSectionProfileError.style.display = 'block';
          profileSectionProfileSuccess.style.display = 'none';
        }
      } catch (err) {
        profileSectionProfileError.textContent = 'Failed to update display name.';
        profileSectionProfileError.style.display = '';
        profileSectionProfileSuccess.style.display = 'none';
      }
    });
    // Security form submit
    profileSectionSecurityForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      const newPassword = profileSectionNewPassword.value;
      profileSectionSecuritySuccess.style.display = 'none';
      profileSectionSecurityError.style.display = 'none';
      if (!newPassword) {
        profileSectionSecurityError.textContent = 'Enter a new password.';
        profileSectionSecurityError.style.display = '';
        return;
      }
      try {
        const res = await fetch('https://n8n.tail851803.ts.net/webhook/6666de10-5902-478d-a865-43136a8f3eca', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user: getCookie('ada_current_user'), newPassword })
        });
        const result = await res.text();
        let message = result.trim();
        const srcdocMatch = message.match(/srcdoc=["']([^"']+)["']/i);
        if (srcdocMatch) {
          message = srcdocMatch[1].trim();
        }
        if (message.toLowerCase().includes('changed password')) {
          profileSectionSecuritySuccess.textContent = message;
          profileSectionSecuritySuccess.style.display = '';
          profileSectionNewPassword.value = '';
          profileSectionSecurityError.style.display = 'none';
        } else {
          profileSectionSecurityError.textContent = message || 'Failed to change password.';
          profileSectionSecurityError.style.display = '';
        }
      } catch (err) {
        profileSectionSecurityError.textContent = 'Failed to change password.';
        profileSectionSecurityError.style.display = '';
      }
    });
    // Update modal header info
    function updateProfileTopbar() {
      const initial = (currentUser && currentUser.length > 0) ? currentUser.charAt(0).toUpperCase() : 'U';
      document.getElementById('profileAvatar').textContent = initial;
      profileDisplayNameTop.textContent = displayName || currentUser || '';
    }

    // Particle network for full-page background (main app)
    const canvas = document.getElementById('particleBgCanvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    const PARTICLE_COUNT = 40;
    const BASE_RADIUS = 2;
    const MAX_RADIUS = 5;
    const LINE_DIST = 220;
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
    function randomVel() {
      return (Math.random() - 0.5) * 0.25;
    }
    function createParticles() {
      particles = [];
      for (let i = 0; i < PARTICLE_COUNT; i++) {
        particles.push({
          x: Math.random() * (canvas.width - MAX_RADIUS * 2) + MAX_RADIUS,
          y: Math.random() * (canvas.height - MAX_RADIUS * 2) + MAX_RADIUS,
          vx: randomVel(),
          vy: randomVel(),
          phase: Math.random() * Math.PI * 2 // for pulsing
        });
      }
    }
    createParticles();
    function getColors() {
      const isLight = document.body.classList.contains('light-mode');
      return {
        point: isLight ? '#bbb' : '#444',
        line: isLight ? 'rgba(120,120,120,0.25)' : 'rgba(180,180,180,0.18)'
      };
    }
    function drawParticles() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const { point, line } = getColors();
      // Draw lines
      for (let i = 0; i < particles.length; i++) {
        for (let j = i + 1; j < particles.length; j++) {
          const dx = particles[i].x - particles[j].x;
          const dy = particles[i].y - particles[j].y;
          const dist = Math.sqrt(dx * dx + dy * dy);
          if (dist < LINE_DIST) {
            ctx.save();
            ctx.globalAlpha = 1 - dist / LINE_DIST;
            ctx.strokeStyle = line;
            ctx.lineWidth = 1.2;
            ctx.beginPath();
            ctx.moveTo(particles[i].x, particles[i].y);
            ctx.lineTo(particles[j].x, particles[j].y);
            ctx.stroke();
            ctx.restore();
          }
        }
      }
      // Draw particles
      for (let i = 0; i < particles.length; i++) {
        // Pulse radius with sine wave
        const t = performance.now() / 1000;
        const pulse = (Math.sin(t + particles[i].phase) + 1) / 2; // 0..1
        const r = BASE_RADIUS + pulse * (MAX_RADIUS - BASE_RADIUS);
        ctx.save();
        ctx.beginPath();
        ctx.arc(particles[i].x, particles[i].y, r, 0, 2 * Math.PI);
        ctx.fillStyle = point;
        ctx.shadowColor = point;
        ctx.shadowBlur = 2;
        ctx.fill();
        ctx.restore();
      }
    }
    function updateParticles() {
      for (let i = 0; i < particles.length; i++) {
        particles[i].x += particles[i].vx;
        particles[i].y += particles[i].vy;
        if (particles[i].x < -MAX_RADIUS) particles[i].x = canvas.width + MAX_RADIUS;
        if (particles[i].x > canvas.width + MAX_RADIUS) particles[i].x = -MAX_RADIUS;
        if (particles[i].y < -MAX_RADIUS) particles[i].y = canvas.height + MAX_RADIUS;
        if (particles[i].y > canvas.height + MAX_RADIUS) particles[i].y = -MAX_RADIUS;
      }
    }
    function animateParticles() {
      updateParticles();
      drawParticles();
      requestAnimationFrame(animateParticles);
    }
    animateParticles();
    // Recolor on theme change
    const observer = new MutationObserver(drawParticles);
    observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });

    // Login background particle network
    const loginBgCanvas = document.getElementById('loginBgCanvas');
    const loginBgCtx = loginBgCanvas.getContext('2d');
    let loginParticles = [];
    const LOGIN_PARTICLE_COUNT = 40;
    const LOGIN_BASE_RADIUS = 2;
    const LOGIN_MAX_RADIUS = 5;
    const LOGIN_LINE_DIST = 220;
    function resizeLoginBgCanvas() {
      loginBgCanvas.width = window.innerWidth;
      loginBgCanvas.height = window.innerHeight;
    }
    resizeLoginBgCanvas();
    window.addEventListener('resize', resizeLoginBgCanvas);
    function randomLoginVel() {
      return (Math.random() - 0.5) * 0.25;
    }
    function createLoginParticles() {
      loginParticles = [];
      for (let i = 0; i < LOGIN_PARTICLE_COUNT; i++) {
        loginParticles.push({
          x: Math.random() * (loginBgCanvas.width - LOGIN_MAX_RADIUS * 2) + LOGIN_MAX_RADIUS,
          y: Math.random() * (loginBgCanvas.height - LOGIN_MAX_RADIUS * 2) + LOGIN_MAX_RADIUS,
          vx: randomLoginVel(),
          vy: randomLoginVel(),
          phase: Math.random() * Math.PI * 2
        });
      }
    }
    createLoginParticles();
    function getLoginBgColors() {
      const isLight = document.body.classList.contains('light-mode');
      return {
        point: isLight ? '#bbb' : '#444',
        line: isLight ? 'rgba(120,120,120,0.25)' : 'rgba(180,180,180,0.18)'
      };
    }
    function drawLoginParticles() {
      loginBgCtx.clearRect(0, 0, loginBgCanvas.width, loginBgCanvas.height);
      const { point, line } = getLoginBgColors();
      for (let i = 0; i < loginParticles.length; i++) {
        for (let j = i + 1; j < loginParticles.length; j++) {
          const dx = loginParticles[i].x - loginParticles[j].x;
          const dy = loginParticles[i].y - loginParticles[j].y;
          const dist = Math.sqrt(dx * dx + dy * dy);
          if (dist < LOGIN_LINE_DIST) {
            loginBgCtx.save();
            loginBgCtx.globalAlpha = 1 - dist / LOGIN_LINE_DIST;
            loginBgCtx.strokeStyle = line;
            loginBgCtx.lineWidth = 1.2;
            loginBgCtx.beginPath();
            loginBgCtx.moveTo(loginParticles[i].x, loginParticles[i].y);
            loginBgCtx.lineTo(loginParticles[j].x, loginParticles[j].y);
            loginBgCtx.stroke();
            loginBgCtx.restore();
          }
        }
      }
      for (let i = 0; i < loginParticles.length; i++) {
        const t = performance.now() / 1000;
        const pulse = (Math.sin(t + loginParticles[i].phase) + 1) / 2;
        const r = LOGIN_BASE_RADIUS + pulse * (LOGIN_MAX_RADIUS - LOGIN_BASE_RADIUS);
        loginBgCtx.save();
        loginBgCtx.beginPath();
        loginBgCtx.arc(loginParticles[i].x, loginParticles[i].y, r, 0, 2 * Math.PI);
        loginBgCtx.fillStyle = point;
        loginBgCtx.shadowColor = point;
        loginBgCtx.shadowBlur = 2;
        loginBgCtx.fill();
        loginBgCtx.restore();
      }
    }
    function updateLoginParticles() {
      for (let i = 0; i < loginParticles.length; i++) {
        loginParticles[i].x += loginParticles[i].vx;
        loginParticles[i].y += loginParticles[i].vy;
        if (loginParticles[i].x < -LOGIN_MAX_RADIUS) loginParticles[i].x = loginBgCanvas.width + LOGIN_MAX_RADIUS;
        if (loginParticles[i].x > loginBgCanvas.width + LOGIN_MAX_RADIUS) loginParticles[i].x = -LOGIN_MAX_RADIUS;
        if (loginParticles[i].y < -LOGIN_MAX_RADIUS) loginParticles[i].y = loginBgCanvas.height + LOGIN_MAX_RADIUS;
        if (loginParticles[i].y > loginBgCanvas.height + LOGIN_MAX_RADIUS) loginParticles[i].y = -LOGIN_MAX_RADIUS;
      }
    }
    function animateLoginParticles() {
      updateLoginParticles();
      drawLoginParticles();
      requestAnimationFrame(animateLoginParticles);
    }
    animateLoginParticles();
    // Recolor on theme change
    const loginBgObserver = new MutationObserver(drawLoginParticles);
    loginBgObserver.observe(document.body, { attributes: true, attributeFilter: ['class'] });

    // Log Out button logic
    profileModalLogoutBtn.addEventListener('click', function() {
      isLoggingOut = true;
      // Clear session cookie
      document.cookie = 'sessionData=; path=/; max-age=0';
      document.cookie = 'adaCurrentUser=; path=/; max-age=0';
      // Reset UI state
      currentUser = '';
      displayName = '';
      messages = [];
      conversationId = uuidv4();
      messagesDiv.innerHTML = '';
      setConvIdText();
      setThinking(false);
      setOnline();
      chatInput.value = '';
      // Clear conversations and sidebar
      conversations = {};
      currentConversationId = null;
      renderConversationList();
      // Hide main app, show login
      mainApp.style.display = 'none';
      loginContainer.style.display = '';
      // Hide profile modal
      profileModalOverlay.classList.remove('show');
      // Reset logout flag after a short delay (in case of async UI updates)
      setTimeout(() => { isLoggingOut = false; }, 500);
    });

    // File upload logic
    const chatFileInput = document.getElementById('chatFileInput');
    const attachBtn = document.getElementById('attachBtn');
    const filePreviewArea = document.getElementById('filePreviewArea');
    let attachedFiles = [];

    attachBtn.addEventListener('click', function() {
      chatFileInput.click();
    });

    chatFileInput.addEventListener('change', function() {
      if (chatFileInput.files && chatFileInput.files.length > 0) {
        // Add new files, avoid duplicates by name/size/type
        const newFiles = Array.from(chatFileInput.files).filter(f => !attachedFiles.some(af => af.name === f.name && af.size === f.size && af.type === f.type));
        attachedFiles = attachedFiles.concat(newFiles);
        renderFilePreviews();
      }
      chatFileInput.value = '';
    });

    function renderFilePreviews() {
      filePreviewArea.innerHTML = '';
      if (attachedFiles.length === 0) {
        filePreviewArea.style.display = 'none';
        return;
      }
      filePreviewArea.style.display = 'flex';
      attachedFiles.forEach((file, idx) => {
        const box = document.createElement('div');
        box.className = 'file-preview-box';
        // Remove button
        const removeBtn = document.createElement('button');
        removeBtn.className = 'file-preview-remove';
        removeBtn.type = 'button';
        removeBtn.innerHTML = '✕';
        removeBtn.title = 'Remove file';
        removeBtn.onclick = function() {
          attachedFiles.splice(idx, 1);
          renderFilePreviews();
        };
        box.appendChild(removeBtn);
        if (file.type.startsWith('image/')) {
          const img = document.createElement('img');
          img.className = 'file-preview-img';
          img.alt = file.name;
          img.title = file.name;
          const url = URL.createObjectURL(file);
          img.src = url;
          img.onload = function() {
            URL.revokeObjectURL(url);
            // Dynamically size box to image aspect ratio (max 96x88)
            const maxW = 96, maxH = 88;
            let w = img.naturalWidth, h = img.naturalHeight;
            if (w > maxW || h > maxH) {
              const scale = Math.min(maxW / w, maxH / h);
              w = w * scale;
              h = h * scale;
            }
            box.style.width = w + 'px';
            box.style.height = h + 'px';
          };
          box.appendChild(img);
        } else {
          // Generic file icon (SVG)
          const icon = document.createElement('div');
          icon.className = 'file-preview-icon';
          icon.innerHTML = `<svg width=\"32\" height=\"32\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><rect x=\"3\" y=\"3\" width=\"18\" height=\"18\" rx=\"2\" ry=\"2\"/><path d=\"M9 3v18\"/></svg>`;
          box.appendChild(icon);
          // File name
          const nameDiv = document.createElement('div');
          nameDiv.className = 'file-preview-name';
          nameDiv.textContent = file.name;
          box.appendChild(nameDiv);
          // Keep non-image box square
          box.style.width = '72px';
          box.style.height = '72px';
        }
        filePreviewArea.appendChild(box);
      });
    }
    function clearFilePreviews() {
      attachedFiles = [];
      filePreviewArea.innerHTML = '';
      filePreviewArea.style.display = 'none';
    }
    function clearErrorState() {
      thinking = false; // Ensure thinking is reset when clearing error state
      pulseOuter.classList.remove('error');
      pulseInnerAnim.classList.remove('error');
      aiStatus.classList.remove('error-status');
      if (!aiStatus.classList.contains('error-status')) {
        aiStatus.textContent = 'AI Ready';
      }
      sendBtn.disabled = false;
      chatInput.disabled = false;
    }
    // Add image preview message to chat
    function addImageMessage(file, opts) {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'message user';
      msgDiv.style.display = 'flex';
      msgDiv.style.flexDirection = 'column';
      msgDiv.style.alignItems = 'flex-start'; // left align
      // File preview box (same as preview area)
      const box = document.createElement('div');
      box.className = 'file-preview-box';
      box.style.alignSelf = 'flex-start';
      // Image
      const img = document.createElement('img');
      img.className = 'file-preview-img';
      img.alt = file.name;
      img.title = file.name;
      img.style.display = 'block';
      img.style.margin = '0 auto';
      img.style.objectFit = 'contain';
      img.style.maxWidth = '144px';
      img.style.maxHeight = '144px';
      img.style.borderRadius = '10px';
      img.style.cursor = 'pointer';
      // Use a persistent blob URL for modal
      const blobUrl = file._blobUrl || URL.createObjectURL(file);
      img.src = blobUrl;
      img.onload = function() {
        // Do not revoke blobUrl here, keep it for modal and chat
        let w = img.naturalWidth, h = img.naturalHeight;
        const maxW = 144, maxH = 144;
        if (w > maxW || h > maxH) {
          const scale = Math.min(maxW / w, maxH / h);
          w = w * scale;
          h = h * scale;
        }
        box.style.width = w + 'px';
        box.style.height = h + 'px';
        box.style.display = 'flex';
        box.style.alignItems = 'center';
        box.style.justifyContent = 'center';
        box.style.padding = '0';
        box.style.margin = '0 0 0 0';
        box.style.border = '3px solid #444';
        box.style.background = '#23242a';
        box.style.boxShadow = '0 0 0 4px #23242a, 0 2px 12px 0 #0005';
        box.style.borderRadius = '12px';
      };
      img.addEventListener('click', function() {
        showImageModal(blobUrl, file.name);
      });
      box.appendChild(img);
      // Remove filename display for images
      const label = document.createElement('div');
      label.style.fontSize = '0.95em';
      label.style.color = '#aaa';
      label.style.marginBottom = '6px';
      label.textContent = '📎 Sent File:';
      label.style.alignSelf = 'flex-start';
      msgDiv.appendChild(label);
      msgDiv.appendChild(box);
      messagesDiv.appendChild(msgDiv);
      setTimeout(() => { msgDiv.style.opacity = 1; msgDiv.style.transform = 'none'; }, 10);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      if (!opts || !opts.renderOnly) {
        messages.push({ text: '[Image] ' + file.name, isUser: true, timestamp: Date.now(), _blobUrl: blobUrl });
        if (typeof conversations !== 'undefined' && conversations[currentConversationId]) {
          conversations[currentConversationId].messages = [...messages];
          conversations[currentConversationId].timestamp = Date.now();
          saveConversations && saveConversations();
          if (typeof renderConversationList === 'function') renderConversationList();
        }
      }
      msgDiv._blobUrl = blobUrl;
    }
    
    // Add AI-generated image message to chat (displays on right side like AI messages)
    function addAIImageMessage(file, opts) {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'message ada'; // Use 'ada' class for right-side alignment
      msgDiv.style.display = 'flex';
      msgDiv.style.flexDirection = 'column';
      msgDiv.style.alignItems = 'flex-end'; // right align for AI messages
      // File preview box (same as preview area)
      const box = document.createElement('div');
      box.className = 'file-preview-box';
      box.style.alignSelf = 'flex-start'; // left align like text messages
      // Image
      const img = document.createElement('img');
      img.className = 'file-preview-img';
      img.alt = file.name;
      img.title = file.name;
      img.style.display = 'block';
      img.style.maxWidth = '100%';
      img.style.width = 'auto';
      img.style.height = 'auto';
      img.style.objectFit = 'contain';
      img.style.borderRadius = '10px';
      img.style.cursor = 'pointer';
      // Use a persistent blob URL for modal
      const blobUrl = file._blobUrl || URL.createObjectURL(file);
      img.src = blobUrl;
      img.onload = function() {
        // Calculate the message box width (similar to text messages)
        const messageBox = msgDiv.closest('.message');
        const maxWidth = messageBox ? messageBox.offsetWidth - 40 : 300; // Account for padding
        
        // Calculate aspect ratio and set height accordingly
        const aspectRatio = img.naturalWidth / img.naturalHeight;
        const calculatedHeight = maxWidth / aspectRatio;
        
        // Set the box to full width and calculated height with proper padding
        box.style.width = '100%';
        box.style.height = (calculatedHeight + 12) + 'px'; // Reduced padding for thinner border
        box.style.display = 'flex';
        box.style.alignItems = 'center';
        box.style.justifyContent = 'center';
        box.style.padding = '6px'; // Reduced padding for thinner border
        box.style.margin = '0 0 0 0';
        box.style.border = '1px solid #444'; // Thinner border
        box.style.background = '#23242a';
        box.style.boxShadow = '0 0 0 2px #23242a, 0 2px 12px 0 #0005'; // Reduced shadow
        box.style.borderRadius = '12px';
        
        // Ensure the image doesn't overflow the message bubble
        img.style.maxWidth = '100%';
        img.style.width = 'auto';
        img.style.height = 'auto';
      };
      img.addEventListener('click', function() {
        showImageModal(blobUrl, file.name);
      });
      box.appendChild(img);
      // Remove filename display for AI images
      const label = document.createElement('div');
      label.style.fontSize = '0.95em';
      label.style.color = '#aaa';
      label.style.marginBottom = '6px';
      label.textContent = '🤖 AI Generated Image:';
      label.style.alignSelf = 'flex-start'; // left align like text messages
      msgDiv.appendChild(label);
      msgDiv.appendChild(box);
      messagesDiv.appendChild(msgDiv);
      setTimeout(() => { msgDiv.style.opacity = 1; msgDiv.style.transform = 'none'; }, 10);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      if (!opts || !opts.renderOnly) {
        // Convert blob to base64 for storage
        const reader = new FileReader();
        reader.onload = function() {
          const base64Data = reader.result;
          console.log('Saving AI image with base64 data:', base64Data.substring(0, 100) + '...');
          messages.push({ 
            text: '[AI Image] ' + file.name, 
            isUser: false, 
            timestamp: Date.now(), 
            _blobUrl: blobUrl,
            _imageData: base64Data,
            _imageType: file.type
          });
          if (typeof conversations !== 'undefined' && conversations[currentConversationId]) {
            conversations[currentConversationId].messages = [...messages];
            conversations[currentConversationId].timestamp = Date.now();
            saveConversations && saveConversations();
            if (typeof renderConversationList === 'function') renderConversationList();
          }
        };
        // Use the actual blob if available, otherwise try to fetch from blob URL
        if (file._blob) {
          reader.readAsDataURL(file._blob);
        } else {
          // Fallback: save without base64 data
          messages.push({ 
            text: '[AI Image] ' + file.name, 
            isUser: false, 
            timestamp: Date.now(), 
            _blobUrl: blobUrl,
            _imageType: file.type
          });
          if (typeof conversations !== 'undefined' && conversations[currentConversationId]) {
            conversations[currentConversationId].messages = [...messages];
            conversations[currentConversationId].timestamp = Date.now();
            saveConversations && saveConversations();
            if (typeof renderConversationList === 'function') renderConversationList();
          }
        }
      }
      msgDiv._blobUrl = blobUrl;
    }
    
    // Add non-image file message to chat
    function addFileMessage(file, opts) {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'message user';
      msgDiv.style.display = 'flex';
      msgDiv.style.flexDirection = 'column';
      msgDiv.style.alignItems = 'flex-start';
      const box = document.createElement('div');
      box.className = 'file-preview-box';
      box.style.alignSelf = 'flex-start';
      const icon = document.createElement('div');
      icon.className = 'file-preview-icon';
      icon.innerHTML = `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><path d="M9 3v18"/></svg>`;
      box.appendChild(icon);
      const nameDiv = document.createElement('div');
      nameDiv.className = 'file-preview-name';
      nameDiv.textContent = file.name;
      box.appendChild(nameDiv);
      box.style.width = '72px';
      box.style.height = '72px';
      const label = document.createElement('div');
      label.style.fontSize = '0.95em';
      label.style.color = '#aaa';
      label.style.marginBottom = '6px';
      label.textContent = '📎 Sent File:';
      label.style.alignSelf = 'flex-start';
      msgDiv.appendChild(label);
      msgDiv.appendChild(box);
      msgDiv.appendChild(nameDiv);
      messagesDiv.appendChild(msgDiv);
      setTimeout(() => { msgDiv.style.opacity = 1; msgDiv.style.transform = 'none'; }, 10);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      if (!opts || !opts.renderOnly) {
        messages.push({ text: '[File] ' + file.name, isUser: true, timestamp: Date.now() });
        if (typeof conversations !== 'undefined' && conversations[currentConversationId]) {
          conversations[currentConversationId].messages = [...messages];
          conversations[currentConversationId].timestamp = Date.now();
          saveConversations && saveConversations();
          if (typeof renderConversationList === 'function') renderConversationList();
        }
      }
    }

    // Image modal logic
    function showImageModal(src, alt) {
      const modal = document.getElementById('imageModal');
      const modalImg = document.getElementById('imageModalImg');
      modalImg.src = src;
      modalImg.alt = alt || '';
      modal.style.display = 'flex';
    }

    // Sidebar logic
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const conversationList = document.getElementById('conversationList');
    const newConversationBtn = document.getElementById('newConversationBtn');
    let conversations = {};
    let currentConversationId = null;

    // Replace all occurrences of 'adaConversations' with a key that includes the username
    function getConvoStorageKey() {
      return currentUser ? `adaConversations_${currentUser}` : 'adaConversations';
    }
    // Update loadConversations and saveConversations to use the per-user key
    function loadConversations() {
      const key = getConvoStorageKey();
      const data = localStorage.getItem(key);
      if (data) {
        try {
          const parsed = JSON.parse(data);
          conversations = parsed.conversations || {};
          currentConversationId = parsed.currentConversationId || null;
        } catch {}
      } else {
        conversations = {};
        currentConversationId = null;
      }
    }
    function saveConversations() {
      const key = getConvoStorageKey();
      localStorage.setItem(key, JSON.stringify({ conversations, currentConversationId }));
    }
    // Render conversation list
    function renderConversationList() {
      conversationList.innerHTML = '';
      // Add 'New Chat' at the top
      const newChatLi = document.createElement('li');
      newChatLi.className = 'conversation-item new-chat-item' + (currentConversationId === null ? ' selected' : '');
      newChatLi.style.fontWeight = 'bold';
      newChatLi.style.display = 'flex';
      newChatLi.style.alignItems = 'center';
      newChatLi.style.justifyContent = 'flex-start';
      newChatLi.style.cursor = thinking ? 'not-allowed' : 'pointer';
      newChatLi.style.background = currentConversationId === null ? '#1ed76022' : '';
      newChatLi.title = thinking ? 'Please wait for the AI to respond before switching.' : '';
      newChatLi.innerHTML = `
        <div class="conversation-icon newchat-gradient${thinking && currentConversationId !== null ? ' disabled-icon' : ''}" style="display:flex;align-items:center;justify-content:center;width:32px;height:32px;font-size:1.5em;">＋</div>
        <span class="conversation-name" style="margin-left:10px;">New Chat</span>
      `;
      newChatLi.addEventListener('click', function() {
        if (thinking) return;
        switchConversation(null);
        document.querySelectorAll('.conversation-item').forEach(item => item.classList.remove('selected'));
        newChatLi.classList.add('selected');
      });
      newChatLi.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        // Optionally, do not show the custom context menu for New Chat, or show a disabled menu
      });
      conversationList.appendChild(newChatLi);
      // Add a gap below 'New Chat'
      const gap = document.createElement('div');
      gap.style.height = '32px';
      gap.style.borderBottom = '1.5px solid #333';
      gap.style.margin = '0 8px 8px 8px';
      conversationList.appendChild(gap);
      // Render the rest of the conversations
      Object.entries(conversations).sort((a, b) => (b[1].timestamp || 0) - (a[1].timestamp || 0)).forEach(([id, conv]) => {
        const li = document.createElement('li');
        li.className = 'conversation-item' + (id === currentConversationId ? ' selected' : '');
        li.dataset.id = id;
        li.style.cursor = thinking ? 'not-allowed' : 'pointer';
        li.title = thinking ? 'Please wait for the AI to respond before switching.' : '';
        // Icon (first letter or 💬)
        const icon = document.createElement('div');
        icon.className = 'conversation-icon gradient' + (thinking && id !== currentConversationId ? ' disabled-icon' : '');
        icon.textContent = (conv.name && conv.name.length > 0) ? conv.name[0].toUpperCase() : '💬';
        li.appendChild(icon);
        // Name (editable)
        const nameSpan = document.createElement('span');
        nameSpan.className = 'conversation-name';
        nameSpan.textContent = conv.name || 'Conversation';
        nameSpan.title = conv.name || 'Conversation';
        li.appendChild(nameSpan);
        // Double-click to rename
        nameSpan.addEventListener('dblclick', function(e) {
          if (thinking) { e.preventDefault(); return; }
          e.stopPropagation();
          nameSpan.contentEditable = true;
          nameSpan.classList.add('editing');
          nameSpan.focus();
          document.execCommand('selectAll', false, null);
        });
        // Save name on blur or Enter
        nameSpan.addEventListener('blur', function() {
          nameSpan.contentEditable = false;
          nameSpan.classList.remove('editing');
          const newName = nameSpan.textContent.trim();
          if (newName && conversations[id].name !== newName) {
            conversations[id].name = newName;
            conversations[id].timestamp = Date.now();
            saveConversations();
            renderConversationList();
          }
        });
        nameSpan.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            nameSpan.blur();
          }
        });
        // Click to switch
        li.addEventListener('click', function() {
          if (thinking) return;
          if (currentConversationId !== id) {
            switchConversation(id);
          }
        });
        // Right-click context menu
        li.addEventListener('contextmenu', function(e) {
          if (thinking) { e.preventDefault(); return; }
          e.preventDefault();
          ctxTargetId = id;
          contextMenu.style.display = 'block';
          contextMenu.style.left = e.clientX + 'px';
          contextMenu.style.top = e.clientY + 'px';
        });
        conversationList.appendChild(li);
      });
    }
    // Switch conversation
    function switchConversation(id) {
      if (!id || !conversations[id]) {
        currentConversationId = null;
        showAdaHome();
        setConvIdText();
        setThinking(false);
        setOnline();
        chatInput.value = '';
        chatInput.focus();
        return;
      }
      currentConversationId = id;
      saveConversations();
      renderConversationList();
          // Load messages for this conversation (make a copy to avoid reference bugs)
    messages = Array.isArray(conversations[id].messages) ? [...conversations[id].messages] : [];
    console.log('Switching to conversation:', id, 'with', messages.length, 'messages');
    conversationId = id;
    setConvIdText();
    displayMessages();
      setThinking(false);
      setOnline();
      chatInput.value = '';
      chatInput.focus();
    }
    // New conversation
    newConversationBtn.addEventListener('click', function() {
      switchConversation(null);
    });
    // Sidebar collapse/expand
    sidebarToggle.addEventListener('click', function() {
      sidebar.classList.toggle('collapsed');
      if (sidebar.classList.contains('collapsed')) {
        sidebarToggle.textContent = '⮞';
        document.cookie = 'adaSidebarCollapsed=true; path=/; max-age=31536000'; // 1 year
      } else {
        sidebarToggle.textContent = '⮜';
        document.cookie = 'adaSidebarCollapsed=false; path=/; max-age=31536000';
      }
    });
    // On page load, restore sidebar state from cookie
    (function() {
      const cookies = document.cookie.split(';');
      let sidebarCollapsed = false;
      for (let cookie of cookies) {
        const idx = cookie.indexOf('=');
        if (idx === -1) continue;
        const name = cookie.slice(0, idx).trim();
        const value = cookie.slice(idx + 1).trim();
        if (name === 'adaSidebarCollapsed' && value === 'true') {
          sidebarCollapsed = true;
          break;
        }
      }
      if (sidebarCollapsed) {
        sidebar.classList.add('collapsed');
        sidebarToggle.textContent = '⮞';
      } else {
        sidebar.classList.remove('collapsed');
        sidebarToggle.textContent = '⮜';
      }
    })();
    // On page load, load conversations or create default
    loadConversations();
    if (!currentConversationId || !conversations[currentConversationId]) {
      currentConversationId = null;
      renderConversationList();
      switchConversation(null);
    } else {
      renderConversationList();
      switchConversation(currentConversationId);
    }

    // Add a function to show the ADA home section (blank welcome page)
    function showAdaHome() {
      messagesDiv.innerHTML = '';
      const homeDiv = document.createElement('div');
      homeDiv.style.display = 'flex';
      homeDiv.style.flexDirection = 'column';
      homeDiv.style.alignItems = 'center';
      homeDiv.style.justifyContent = 'center';
      homeDiv.style.height = 'calc(100% - 40px)';
      homeDiv.style.color = '#aaa';
      homeDiv.style.fontSize = '1.2rem';
      homeDiv.innerHTML = `
        <div style="text-align: center; margin: 0 auto;">
          <div style="font-size: 1.5em; font-weight: bold; margin-bottom: 18px;">Welcome to <b>New Chat</b>!</div>
          <div style="font-size: 1.05em; color: #888; line-height: 1.5;">
            Start a new conversation<br>or select one from the sidebar.
          </div>
        </div>
      `;
      messagesDiv.appendChild(homeDiv);
    }
    // On login, if no conversations, show ADA home
    if (!currentConversationId || !conversations[currentConversationId]) {
      showAdaHome();
    }
    // On first message sent when no conversation is selected, start a new conversation and show 'Switched to a new conversation.'
    const origChatFormSubmit = chatForm.onsubmit || null;
    // Add a tempMessageDraft variable to hold the message and files when starting a new conversation from ADA home
    let tempMessageDraft = null;
    chatForm.addEventListener('submit', function(e) {
      if (!currentConversationId) {
        e.preventDefault();
        // Save the message and files to a temp variable
        const userText = chatInput.value.trim();
        if (!userText && attachedFiles.length === 0) return;
        tempMessageDraft = {
          text: userText,
          files: attachedFiles.slice()
        };
        // Start a new conversation
        const id = uuidv4();
        conversations[id] = {
          name: 'Conversation',
          messages: [],
          timestamp: Date.now(),
        };
        currentConversationId = id;
        saveConversations();
        renderConversationList();
        switchConversation(id);
        // Clear input and file previews (will be restored below)
        chatInput.value = '';
        clearFilePreviews();
        // Now, send the saved message/files as the first message in the new conversation
        setTimeout(() => {
          if (tempMessageDraft) {
            chatInput.value = tempMessageDraft.text;
            attachedFiles = tempMessageDraft.files.slice();
            renderFilePreviews();
            autoResizeTextarea(); // Resize textarea when restoring draft
            tempMessageDraft = null;
            // Actually submit the form again
            chatForm.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
          }
        }, 0);
        return;
      }
      if (origChatFormSubmit) origChatFormSubmit.call(chatForm, e);
    }, true);

    // Add context menu HTML to the body
    const contextMenu = document.createElement('div');
    contextMenu.id = 'conversationContextMenu';
    contextMenu.style.position = 'fixed';
    contextMenu.style.display = 'none';
    contextMenu.style.background = '#23242a';
    contextMenu.style.color = '#fff';
    contextMenu.style.borderRadius = '8px';
    contextMenu.style.boxShadow = '0 2px 12px #0007';
    contextMenu.style.zIndex = '99999';
    contextMenu.innerHTML = `
      <div id="ctxRename" style="padding:10px 24px;cursor:pointer;">Rename</div>
      <div id="ctxDelete" style="padding:10px 24px;cursor:pointer;color:#ff5252;">Delete</div>
    `;
    document.body.appendChild(contextMenu);
    let ctxTargetId = null;
    // Hide context menu on click elsewhere
    window.addEventListener('click', function() {
      contextMenu.style.display = 'none';
    });
    // Rename handler
    contextMenu.querySelector('#ctxRename').addEventListener('click', function() {
      if (ctxTargetId && conversationList) {
        const li = conversationList.querySelector(`[data-id="${ctxTargetId}"]`);
        if (li) {
          const nameSpan = li.querySelector('.conversation-name');
          if (nameSpan) {
            nameSpan.dispatchEvent(new Event('dblclick'));
            nameSpan.focus();
          }
        }
      }
      contextMenu.style.display = 'none';
    });
    // Delete handler
    contextMenu.querySelector('#ctxDelete').addEventListener('click', function() {
      if (ctxTargetId && conversations[ctxTargetId]) {
        const wasActive = (currentConversationId === ctxTargetId);
        delete conversations[ctxTargetId];
        saveConversations();
        // Remove any cookies for this conversation (if present)
        document.cookie = `${ctxTargetId}=; path=/; max-age=0`;
        renderConversationList();
        if (wasActive) {
          currentConversationId = null;
          switchConversation(null);
          // Visually mark 'New Chat' as selected and remove 'selected' from others
          setTimeout(() => {
            document.querySelectorAll('.conversation-item').forEach(item => item.classList.remove('selected'));
            const newChatItem = document.querySelector('.new-chat-item');
            if (newChatItem) newChatItem.classList.add('selected');
          }, 0);
        }
      }
      contextMenu.style.display = 'none';
    });
    
    // Cookie utility functions
    function setCookie(name, value, days = 30) {
      const expires = new Date();
      expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
      document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
    }
    
    function getCookie(name) {
      const nameEQ = name + "=";
      const ca = document.cookie.split(';');
      for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
      }
      return null;
    }
    
    function deleteCookie(name) {
      document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;`;
    }
    
    // Filter iframe content from response
    function filterIframeContent(responseText) {
      // Remove iframe tags and their content
      const iframeRegex = /<iframe[^>]*>.*?<\/iframe>/gis;
      let filtered = responseText.replace(iframeRegex, '');
      
      // Also try to extract content that might be wrapped in iframe-like structures
      const base64Regex = /[A-Za-z0-9+/]{20,}={0,2}/g;
      const matches = filtered.match(base64Regex);
      
      if (matches && matches.length > 0) {
        // Return the longest base64-like string found
        return matches.reduce((a, b) => a.length > b.length ? a : b);
      }
      
      return filtered.trim();
    }
    
    // Login form handler
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value.trim();
      const loginError = document.getElementById('loginError');
      const submitBtn = this.querySelector('button[type="submit"]');
      
      if (!username || !password) {
        loginError.style.display = 'block';
        loginError.textContent = 'Please enter both username and password';
        return;
      }
      
      // Show loading state
      submitBtn.classList.add('login-btn-loading');
      submitBtn.textContent = 'Logging in...';
      loginError.style.display = 'none';
      
      try {
        // First, validate login credentials with existing webhook
        console.log('Attempting login validation for user:', username);
        const loginResponse = await fetch('https://n8n.tail851803.ts.net/webhook/8c65cdd1-4ace-49eb-ab59-c9666cb0fc41', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            username: username, 
            password: password
          })
        });
        
        console.log('Login validation response status:', loginResponse.status);
        
        if (!loginResponse.ok) {
          throw new Error(`Login validation failed with status: ${loginResponse.status}`);
        }
        
        const loginResult = await loginResponse.text();
        console.log('Login validation result:', loginResult);
        console.log('Login result length:', loginResult.length);
        
        // Check if login was successful (adjust this based on your webhook response)
        if (loginResult.toLowerCase().includes('invalid') || loginResult.toLowerCase().includes('error') || loginResult.toLowerCase().includes('failed')) {
          throw new Error('Invalid credentials');
        }
        
        // If login result is empty, that might be success for this webhook
        if (loginResult.length === 0) {
          console.log('Empty login result - treating as successful validation');
        }
        
        // If login validation successful, get the login token
        console.log('Login validation successful, requesting token...');
        let token = null;
        
        try {
          const tokenResponse = await fetch('https://n8n.tail851803.ts.net/webhook/65ab51f7-4cf3-421e-b8f6-f946a3799beb', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              user: username, 
              password: password 
            })
          });
          
          console.log('Token response status:', tokenResponse.status);
          
          if (!tokenResponse.ok) {
            throw new Error(`Token retrieval failed with status: ${tokenResponse.status}. Authentication cannot proceed without a valid security token.`);
          }
          
          let tokenResult = await tokenResponse.text();
          console.log('Raw token response:', tokenResult);
          
          // Filter out iframe content and extract base64 token
          token = filterIframeContent(tokenResult);
          console.log('Filtered token:', token);
          
          if (!token || token.length < 10) {
            throw new Error('Invalid or empty token received. Authentication cannot proceed without a valid security token.');
          }
          
        } catch (tokenError) {
          console.error('Token retrieval error:', tokenError);
          // Ensure user cannot proceed without a valid token
          throw new Error(`Security token error: ${tokenError.message || 'Failed to obtain required security token. Login cannot continue.'}`);
        }
        
        // Only proceed if we have a valid token
        if (!token) {
          throw new Error('Critical security error: No valid token available. Login aborted for security reasons.');
        }
        
        // Store login data only after successful token retrieval
        currentUser = username;
        loginToken = token;
        
        // Save token in cookie only after successful validation
        try {
          console.log('About to save to cookies - username:', username, 'token length:', token ? token.length : 'null');
          setCookie('ada_login_token', token, 90);
          setCookie('ada_current_user', username, 90);
          console.log('Successfully saved login token and user to cookies');
          
          // Verify cookies were saved
          const savedToken = getCookie('ada_login_token');
          const savedUser = getCookie('ada_current_user');
          console.log('Verification - saved token length:', savedToken ? savedToken.length : 'null', 'saved user:', savedUser);
        } catch (cookieError) {
          console.error('Failed to save login data to cookies:', cookieError);
          // Don't throw here as login was successful, just log the cookie issue
        }
        
        // Hide login container and show main app
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        document.getElementById('aiTopbar').style.display = 'flex';
        
        // Update profile display
        updateProfileDisplay();
        
        // Load user-specific conversations
        loadConversations();
        renderConversationList();
        
        // Focus on chat input
        setTimeout(() => {
          chatInput.focus();
        }, 100);
        
      } catch (error) {
        console.error('Login error:', error);
        loginError.style.display = 'block';
        loginError.textContent = error.message || 'Login failed. Please try again.';
      } finally {
        // Reset button state
        submitBtn.classList.remove('login-btn-loading');
        submitBtn.textContent = 'Log In';
      }
    });
    
    // Update profile display
    function updateProfileDisplay() {
      if (currentUser) {
        const profileAvatar = document.getElementById('profileAvatar');
        const profileDisplayName = document.getElementById('profileDisplayNameTop');
        
        if (profileAvatar) {
          profileAvatar.textContent = currentUser.charAt(0).toUpperCase();
        }
        if (profileDisplayName) {
          profileDisplayName.textContent = currentUser;
        }
      }
    }
    
    // Logout function
    async function logout() {
      console.log('🚪 Logout function called');
      
      // Get current values from cookies before clearing anything
      const savedToken = getCookie('ada_login_token');
      const savedUser = getCookie('ada_current_user');
      
      console.log('Current user from variable:', currentUser);
      console.log('Current user from cookie:', savedUser);
      console.log('Login token from variable exists:', loginToken ? 'yes' : 'no');
      console.log('Login token from cookie exists:', savedToken ? 'yes' : 'no');
      
      try {
        // Call logout webhook to remove token - use cookie values to ensure we have them
        if (savedToken && savedUser) {
          console.log('✅ Both savedToken and savedUser exist - sending webhook request');
          console.log('Sending logout request to webhook...');
          const response = await fetch('https://n8n.tail851803.ts.net/webhook/116554dc-8786-42d1-81f2-1c970ee8b765', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              ada_current_user: savedUser, 
              ada_login_token: savedToken 
            })
          });
          
          if (response.ok) {
            const responseText = await response.text();
            console.log('Logout webhook response:', responseText);
            
            if (responseText.toLowerCase().includes('deleted')) {
              console.log('✅ Token successfully deleted on server');
            } else if (responseText.toLowerCase().includes('failed')) {
              console.log('❌ Failed to delete token on server');
            } else {
              console.log('⚠️ Unexpected logout response format');
            }
          } else {
            console.log('❌ Logout webhook request failed with status:', response.status);
          }
        } else {
          console.log('❌ Cannot send logout webhook - missing loginToken or currentUser');
          console.log('loginToken:', loginToken ? 'present' : 'missing');
          console.log('currentUser:', currentUser ? currentUser : 'missing');
        }
      } catch (error) {
        console.error('Logout webhook error:', error);
      }
      
      // Clear local data
      currentUser = null;
      loginToken = null;
      
      // Clear cookies
      deleteCookie('ada_login_token');
      deleteCookie('ada_current_user');
      
      // Clear conversations and messages
      conversations = {};
      messages = [];
      currentConversationId = null;
      
      // Reset UI
      document.getElementById('loginContainer').style.display = 'flex';
      document.getElementById('mainApp').style.display = 'none';
      document.getElementById('aiTopbar').style.display = 'none';
      
      // Clear login form
      document.getElementById('loginUsername').value = '';
      document.getElementById('loginPassword').value = '';
      document.getElementById('loginError').style.display = 'none';
      
      // Focus on username field
      setTimeout(() => {
        document.getElementById('loginUsername').focus();
      }, 100);
    }
    
    // Check for existing login on page load
    async function checkExistingLogin() {
      const savedToken = getCookie('ada_login_token');
      const savedUser = getCookie('ada_current_user');
      
      if (savedToken && savedUser) {
        try {
          // Validate cookies with webhook
          const response = await fetch('https://n8n.tail851803.ts.net/webhook/db4d785a-1d4a-46d3-ae4f-648e5e495198', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              ada_current_user: savedUser,
              ada_login_token: savedToken
            })
          });
          
          if (response.ok) {
            const responseText = await response.text();
            console.log('Webhook response received:', responseText);
            console.log('Response length:', responseText.length);
            console.log('Contains "valid":', responseText.toLowerCase().includes('valid'));
            console.log('Contains "invalid":', responseText.toLowerCase().includes('invalid'));
            
            // Check if response contains "valid" (with or without iframe)
            if (responseText.toLowerCase().includes('valid')) {
              console.log('✅ Token validation successful - proceeding with auto-login');
              // Token is valid, proceed with login
              currentUser = savedUser;
              loginToken = savedToken;
              
              console.log('Setting currentUser to:', currentUser);
              console.log('Setting loginToken to:', loginToken ? 'present' : 'null');
              
              // Show main app
              document.getElementById('loginContainer').style.display = 'none';
              document.getElementById('mainApp').style.display = 'block';
              document.getElementById('aiTopbar').style.display = 'flex';
              
              console.log('UI elements updated - login should be complete');
              
              // Update profile display
              updateProfileDisplay();
              
              // Load user-specific conversations but always start with new chat
              loadConversations();
              currentConversationId = null; // Force new chat on auto-login
              renderConversationList();
              
              return true;
            } else if (responseText.toLowerCase().includes('invalid')) {
              // Token is invalid, clear cookies and show login
              console.log('❌ Login token validation failed - clearing cookies');
              deleteCookie('ada_login_token');
              deleteCookie('ada_current_user');
              return false;
            } else {
              console.log('⚠️ Unexpected webhook response format - clearing cookies');
              console.log('Response did not contain "valid" or "invalid"');
              deleteCookie('ada_login_token');
              deleteCookie('ada_current_user');
              return false;
            }
          } else {
            console.log('❌ Webhook request failed with status:', response.status);
            return false;
          }
        } catch (error) {
          console.error('Error validating login cookies:', error);
          // On error, clear cookies to be safe
          deleteCookie('ada_login_token');
          deleteCookie('ada_current_user');
        }
      }
      
      return false;
    }
    
    // Profile modal logout button handler
    document.getElementById('profileModalLogoutBtn').addEventListener('click', function() {
      // Close profile modal first
      document.getElementById('profileModalOverlay').classList.remove('show');
      
      // Perform logout
      logout();
    });
    
    // Profile menu click handler
    document.getElementById('profileUserBox').addEventListener('click', function() {
      document.getElementById('profileModalOverlay').classList.add('show');
    });
    
    // Profile modal close handlers
    document.getElementById('profileModalClose').addEventListener('click', function() {
      document.getElementById('profileModalOverlay').classList.remove('show');
    });
    
    document.getElementById('profileModalOverlay').addEventListener('click', function(e) {
      if (e.target === this) {
        this.classList.remove('show');
      }
    });
    
    // Initialize login system on page load
    document.addEventListener('DOMContentLoaded', async function() {
      const loginSuccessful = await checkExistingLogin();
      if (!loginSuccessful) {
        // Show login form and focus on username
        document.getElementById('loginContainer').style.display = 'flex';
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('aiTopbar').style.display = 'none';
        
        setTimeout(() => {
          document.getElementById('loginUsername').focus();
        }, 100);
      }
    });
    
    // Call initialization immediately if DOM is already loaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', async () => await checkExistingLogin());
    } else {
      checkExistingLogin();
    }
  </script>
  
  <!-- Add this before </body> (modal HTML) -->
  <div id="imageModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); z-index:9999; align-items:center; justify-content:center;">
    <button id="imageModalClose" style="position:absolute;top:24px;right:32px;font-size:2.2rem;background:none;border:none;color:#fff;cursor:pointer;z-index:10001;line-height:1;">&times;</button>
    <img id="imageModalImg" src="" alt="Preview" style="max-width:90vw; max-height:90vh; border-radius:18px; box-shadow:0 4px 32px #000a; display:block; margin:auto; background:#222;" />
  </div>
</body>
</html>
